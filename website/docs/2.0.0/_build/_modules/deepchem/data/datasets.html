<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>deepchem.data.datasets &mdash; deepchem 1.3.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.3.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="deepchem 1.3.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-inverse navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><span><img src="../../../_static/logo.png"></span>
          deepchem</a>
        <span class="navbar-text navbar-version pull-left"><b>1.3</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../notebooks/index.html">Notebooks</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../deepchem.html">deepchem package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for deepchem.data.datasets</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains wrapper class for datasets.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">deepchem.utils.save</span> <span class="kn">import</span> <span class="n">save_to_disk</span><span class="p">,</span> <span class="n">save_metadata</span>
<span class="kn">from</span> <span class="nn">deepchem.utils.save</span> <span class="kn">import</span> <span class="n">load_from_disk</span>
<span class="kn">from</span> <span class="nn">deepchem.utils.save</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_hdf</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Bharath Ramsundar&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2016, Stanford University&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>


<div class="viewcode-block" id="sparsify_features"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.sparsify_features">[docs]</a><span class="k">def</span> <span class="nf">sparsify_features</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Extracts a sparse feature representation from dense feature array.&quot;&quot;&quot;</span>
  <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
  <span class="n">X_sparse</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
    <span class="n">nonzero_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nonzero_vals</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">nonzero_inds</span><span class="p">]</span>
    <span class="n">X_sparse</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nonzero_inds</span><span class="p">,</span> <span class="n">nonzero_vals</span><span class="p">))</span>
  <span class="n">X_sparse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_sparse</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">X_sparse</span></div>


<div class="viewcode-block" id="densify_features"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.densify_features">[docs]</a><span class="k">def</span> <span class="nf">densify_features</span><span class="p">(</span><span class="n">X_sparse</span><span class="p">,</span> <span class="n">num_features</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Expands sparse feature representation to dense feature array.&quot;&quot;&quot;</span>
  <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_sparse</span><span class="p">)</span>
  <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_features</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
    <span class="n">nonzero_inds</span><span class="p">,</span> <span class="n">nonzero_vals</span> <span class="o">=</span> <span class="n">X_sparse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">nonzero_inds</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nonzero_vals</span>
  <span class="k">return</span> <span class="n">X</span></div>


<div class="viewcode-block" id="pad_features"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.pad_features">[docs]</a><span class="k">def</span> <span class="nf">pad_features</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">X_b</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Pads a batch of features to have precisely batch_size elements.</span>

<span class="sd">  Version of pad_batch for use at prediction time.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_b</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">num_samples</span> <span class="o">==</span> <span class="n">batch_size</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">X_b</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># By invariant of when this is called, can assume num_samples &gt; 0</span>
    <span class="c1"># and num_samples &lt; batch_size</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">feature_shape</span> <span class="o">=</span> <span class="n">X_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
      <span class="n">X_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="n">feature_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">X_b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">X_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">X_b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Fill in batch arrays</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">batch_size</span><span class="p">:</span>
      <span class="n">num_left</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">start</span>
      <span class="k">if</span> <span class="n">num_left</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">:</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">num_left</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">num_samples</span>
      <span class="n">X_out</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span> <span class="o">+</span> <span class="n">increment</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_b</span><span class="p">[:</span><span class="n">increment</span><span class="p">]</span>
      <span class="n">start</span> <span class="o">+=</span> <span class="n">increment</span>
    <span class="k">return</span> <span class="n">X_out</span></div>


<div class="viewcode-block" id="pad_batch"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.pad_batch">[docs]</a><span class="k">def</span> <span class="nf">pad_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">X_b</span><span class="p">,</span> <span class="n">y_b</span><span class="p">,</span> <span class="n">w_b</span><span class="p">,</span> <span class="n">ids_b</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Pads batch to have size precisely batch_size elements.</span>

<span class="sd">  Fills in batch by wrapping around samples till whole batch is filled.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_b</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">num_samples</span> <span class="o">==</span> <span class="n">batch_size</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X_b</span><span class="p">,</span> <span class="n">y_b</span><span class="p">,</span> <span class="n">w_b</span><span class="p">,</span> <span class="n">ids_b</span><span class="p">)</span>
  <span class="c1"># By invariant of when this is called, can assume num_samples &gt; 0</span>
  <span class="c1"># and num_samples &lt; batch_size</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">feature_shape</span> <span class="o">=</span> <span class="n">X_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">X_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="n">feature_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">X_b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">X_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">X_b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">y_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">y_out</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">y_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">y_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">y_b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">w_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">w_out</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">w_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">w_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">w_b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

  <span class="n">ids_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ids_b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

  <span class="c1"># Fill in batch arrays</span>
  <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="c1"># Only the first set of copy will be counted in training loss</span>
  <span class="k">if</span> <span class="n">w_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">w_out</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span> <span class="o">+</span> <span class="n">num_samples</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_b</span><span class="p">[:]</span>

  <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">batch_size</span><span class="p">:</span>
    <span class="n">num_left</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">if</span> <span class="n">num_left</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">:</span>
      <span class="n">increment</span> <span class="o">=</span> <span class="n">num_left</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">increment</span> <span class="o">=</span> <span class="n">num_samples</span>
    <span class="n">X_out</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span> <span class="o">+</span> <span class="n">increment</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_b</span><span class="p">[:</span><span class="n">increment</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">y_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">y_out</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span> <span class="o">+</span> <span class="n">increment</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_b</span><span class="p">[:</span><span class="n">increment</span><span class="p">]</span>

    <span class="n">ids_out</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span> <span class="o">+</span> <span class="n">increment</span><span class="p">]</span> <span class="o">=</span> <span class="n">ids_b</span><span class="p">[:</span><span class="n">increment</span><span class="p">]</span>
    <span class="n">start</span> <span class="o">+=</span> <span class="n">increment</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">X_out</span><span class="p">,</span> <span class="n">y_out</span><span class="p">,</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">ids_out</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dataset"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Dataset">[docs]</a><span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Abstract base class for datasets defined by X, y, w elements.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

<div class="viewcode-block" id="Dataset.__len__"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Dataset.__len__">[docs]</a>  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the number of elements in the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Dataset.get_shape"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Dataset.get_shape">[docs]</a>  <span class="k">def</span> <span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the shape of the dataset.</span>

<span class="sd">    Returns four tuples, giving the shape of the X, y, w, and ids arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Dataset.get_task_names"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Dataset.get_task_names">[docs]</a>  <span class="k">def</span> <span class="nf">get_task_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the names of the tasks associated with this dataset.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the X vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the y vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the ids vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">w</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the weight vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

<div class="viewcode-block" id="Dataset.iterbatches"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Dataset.iterbatches">[docs]</a>  <span class="k">def</span> <span class="nf">iterbatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">deterministic</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">pad_batches</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;Get an object that iterates over minibatches from the dataset.</span>

<span class="sd">    Each minibatch is returned as a tuple of four numpy arrays: (X, y, w, ids).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Dataset.itersamples"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Dataset.itersamples">[docs]</a>  <span class="k">def</span> <span class="nf">itersamples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get an object that iterates over the samples in the dataset.</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; dataset = NumpyDataset(np.ones((2,2)))</span>
<span class="sd">    &gt;&gt;&gt; for x, y, w, id in dataset.itersamples():</span>
<span class="sd">    ...   print(x, y, w, id)</span>
<span class="sd">    [ 1.  1.] [ 0.] [ 0.] 0</span>
<span class="sd">    [ 1.  1.] [ 0.] [ 0.] 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Dataset.transform"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Dataset.transform">[docs]</a>  <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a new dataset by applying a transformation to every sample in this dataset.</span>

<span class="sd">    The argument is a function that can be called as follows:</span>

<span class="sd">    &gt;&gt; newx, newy, neww = fn(x, y, w)</span>

<span class="sd">    It might be called only once with the whole dataset, or multiple times with</span>
<span class="sd">    different subsets of the data.  Each time it is called, it should transform</span>
<span class="sd">    the samples and return the transformed data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fn: function</span>
<span class="sd">      A function to apply to each sample in the dataset</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    a newly constructed Dataset object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Dataset.get_statistics"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Dataset.get_statistics">[docs]</a>  <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_stats</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">y_stats</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute and return statistics of this dataset.&quot;&quot;&quot;</span>
    <span class="n">X_means</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">X_m2</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">y_means</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">y_m2</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itersamples</span><span class="p">():</span>
      <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">X_stats</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">X_means</span>
        <span class="n">X_means</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">X_m2</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_means</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">y_stats</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_means</span>
        <span class="n">y_means</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">y_m2</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_means</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">X_stds</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">y_stds</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">X_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X_m2</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
      <span class="n">y_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y_m2</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">X_stats</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">y_stats</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">X_means</span><span class="p">,</span> <span class="n">X_stds</span>
    <span class="k">elif</span> <span class="n">y_stats</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">X_stats</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">y_means</span><span class="p">,</span> <span class="n">y_stds</span>
    <span class="k">elif</span> <span class="n">X_stats</span> <span class="ow">and</span> <span class="n">y_stats</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">X_means</span><span class="p">,</span> <span class="n">X_stds</span><span class="p">,</span> <span class="n">y_means</span><span class="p">,</span> <span class="n">y_stds</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span></div></div>


<div class="viewcode-block" id="NumpyDataset"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.NumpyDataset">[docs]</a><span class="k">class</span> <span class="nc">NumpyDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Dataset defined by in-memory numpy arrays.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n_tasks</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="c1"># The -1 indicates that y will be reshaped to have length -1</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Set labels to be zero, with zero weights</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_tasks</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_X</span> <span class="o">=</span> <span class="n">X</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_w</span> <span class="o">=</span> <span class="n">w</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

<div class="viewcode-block" id="NumpyDataset.__len__"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.NumpyDataset.__len__">[docs]</a>  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the number of elements in the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">)</span></div>

<div class="viewcode-block" id="NumpyDataset.get_shape"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.NumpyDataset.get_shape">[docs]</a>  <span class="k">def</span> <span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the shape of the dataset.</span>

<span class="sd">    Returns four tuples, giving the shape of the X, y, w, and ids arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="o">.</span><span class="n">shape</span></div>

<div class="viewcode-block" id="NumpyDataset.get_task_names"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.NumpyDataset.get_task_names">[docs]</a>  <span class="k">def</span> <span class="nf">get_task_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the names of the tasks associated with this dataset.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the X vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the y vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the ids vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">w</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the weight vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span>

<div class="viewcode-block" id="NumpyDataset.iterbatches"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.NumpyDataset.iterbatches">[docs]</a>  <span class="k">def</span> <span class="nf">iterbatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">deterministic</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">pad_batches</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get an object that iterates over minibatches from the dataset.</span>

<span class="sd">    Each minibatch is returned as a tuple of four numpy arrays: (X, y, w, ids).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">,</span> <span class="n">pad_batches</span><span class="p">):</span>
      <span class="n">n_samples</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">deterministic</span><span class="p">:</span>
        <span class="n">sample_perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sample_perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">n_samples</span>
      <span class="n">batch_idx</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">num_batches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
      <span class="k">while</span> <span class="n">batch_idx</span> <span class="o">&lt;</span> <span class="n">num_batches</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="n">perm_indices</span> <span class="o">=</span> <span class="n">sample_perm</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">X_batch</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_X</span><span class="p">[</span><span class="n">perm_indices</span><span class="p">]</span>
        <span class="n">y_batch</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">perm_indices</span><span class="p">]</span>
        <span class="n">w_batch</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_w</span><span class="p">[</span><span class="n">perm_indices</span><span class="p">]</span>
        <span class="n">ids_batch</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_ids</span><span class="p">[</span><span class="n">perm_indices</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pad_batches</span><span class="p">:</span>
          <span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">w_batch</span><span class="p">,</span> <span class="n">ids_batch</span><span class="p">)</span> <span class="o">=</span> <span class="n">pad_batch</span><span class="p">(</span>
              <span class="n">batch_size</span><span class="p">,</span> <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">w_batch</span><span class="p">,</span> <span class="n">ids_batch</span><span class="p">)</span>
        <span class="n">batch_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">w_batch</span><span class="p">,</span> <span class="n">ids_batch</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">,</span> <span class="n">pad_batches</span><span class="p">)</span></div>

<div class="viewcode-block" id="NumpyDataset.itersamples"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.NumpyDataset.itersamples">[docs]</a>  <span class="k">def</span> <span class="nf">itersamples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get an object that iterates over the samples in the dataset.</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; dataset = NumpyDataset(np.ones((2,2)))</span>
<span class="sd">    &gt;&gt;&gt; for x, y, w, id in dataset.itersamples():</span>
<span class="sd">    ...   print(x, y, w, id)</span>
<span class="sd">    [ 1.  1.] [ 0.] [ 0.] 0</span>
<span class="sd">    [ 1.  1.] [ 0.] [ 0.] 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">))</span></div>

<div class="viewcode-block" id="NumpyDataset.transform"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.NumpyDataset.transform">[docs]</a>  <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a new dataset by applying a transformation to every sample in this dataset.</span>

<span class="sd">    The argument is a function that can be called as follows:</span>

<span class="sd">    &gt;&gt; newx, newy, neww = fn(x, y, w)</span>

<span class="sd">    It might be called only once with the whole dataset, or multiple times with</span>
<span class="sd">    different subsets of the data.  Each time it is called, it should transform</span>
<span class="sd">    the samples and return the transformed data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fn: function</span>
<span class="sd">      A function to apply to each sample in the dataset</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    a newly constructed Dataset object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newx</span><span class="p">,</span> <span class="n">newy</span><span class="p">,</span> <span class="n">neww</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">NumpyDataset</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">newy</span><span class="p">,</span> <span class="n">neww</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">[:])</span></div>

<div class="viewcode-block" id="NumpyDataset.select"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.NumpyDataset.select">[docs]</a>  <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">select_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new dataset from a selection of indices from self.</span>

<span class="sd">    TODO(rbharath): select_dir is here due to dc.splits always passing in</span>
<span class="sd">    splits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    indices: list</span>
<span class="sd">      List of indices to select.</span>
<span class="sd">    select_dir: string</span>
<span class="sd">      Ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">NumpyDataset</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span></div>

  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="NumpyDataset.from_DiskDataset"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.NumpyDataset.from_DiskDataset">[docs]</a>  <span class="k">def</span> <span class="nf">from_DiskDataset</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : DiskDataset</span>
<span class="sd">    DiskDataset to transorm to NumpyDataset</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NumpyDataset</span>
<span class="sd">      Data of ds as NumpyDataset</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">NumpyDataset</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DiskDataset"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset">[docs]</a><span class="k">class</span> <span class="nc">DiskDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A Dataset that is stored as a set of files on disk.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns featurized dataframes into numpy files, writes them &amp; metadata to disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Loading dataset from disk.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_metadata</span><span class="p">()</span>

  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="DiskDataset.create_dataset"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.create_dataset">[docs]</a>  <span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">shard_generator</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new DiskDataset</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shard_generator: Iterable</span>
<span class="sd">      An iterable (either a list or generator) that provides tuples of data</span>
<span class="sd">      (X, y, w, ids). Each tuple will be written to a separate shard on disk.</span>
<span class="sd">    data_dir: str</span>
<span class="sd">      Filename for data directory. Creates a temp directory if none specified.</span>
<span class="sd">    tasks: list</span>
<span class="sd">      List of tasks for this dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">data_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
      <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

    <span class="n">metadata_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">shard_num</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shard_generator</span><span class="p">):</span>
      <span class="n">basename</span> <span class="o">=</span> <span class="s2">&quot;shard-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">shard_num</span>
      <span class="n">metadata_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
          <span class="n">DiskDataset</span><span class="o">.</span><span class="n">write_data_to_disk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span>
                                         <span class="n">ids</span><span class="p">))</span>
    <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">_construct_metadata</span><span class="p">(</span><span class="n">metadata_rows</span><span class="p">)</span>
    <span class="n">save_metadata</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">metadata_df</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">)</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;TIMING: dataset construction took </span><span class="si">%0.3f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="p">),</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DiskDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.load_metadata"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.load_metadata">[docs]</a>  <span class="k">def</span> <span class="nf">load_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">tasks_filename</span><span class="p">,</span> <span class="n">metadata_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_filename</span><span class="p">()</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tasks_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
      <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">metadata_filename</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
      <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">)),</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">metadata_df</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">pass</span>

    <span class="c1"># Load obsolete format -&gt; save in new format</span>
    <span class="n">metadata_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;metadata.joblib&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metadata_filename</span><span class="p">):</span>
      <span class="n">tasks</span><span class="p">,</span> <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">metadata_filename</span><span class="p">)</span>
      <span class="k">del</span> <span class="n">metadata_df</span><span class="p">[</span><span class="s1">&#39;task_names&#39;</span><span class="p">]</span>
      <span class="k">del</span> <span class="n">metadata_df</span><span class="p">[</span><span class="s1">&#39;basename&#39;</span><span class="p">]</span>
      <span class="n">save_metadata</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">metadata_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">metadata_df</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No Metadata Found On Disk&quot;</span><span class="p">)</span></div>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_construct_metadata</span><span class="p">(</span><span class="n">metadata_entries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a dataframe containing metadata.</span>

<span class="sd">    metadata_entries should have elements returned by write_data_to_disk</span>
<span class="sd">    above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadata_entries</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metadata_df</span>

  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="DiskDataset.write_data_to_disk"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.write_data_to_disk">[docs]</a>  <span class="k">def</span> <span class="nf">write_data_to_disk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span>
                         <span class="n">basename</span><span class="p">,</span>
                         <span class="n">tasks</span><span class="p">,</span>
                         <span class="n">X</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">w</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">ids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">out_X</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-X.joblib&quot;</span> <span class="o">%</span> <span class="n">basename</span>
      <span class="n">save_to_disk</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">out_X</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out_X</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">out_y</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-y.joblib&quot;</span> <span class="o">%</span> <span class="n">basename</span>
      <span class="n">save_to_disk</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">out_y</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out_y</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">out_w</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-w.joblib&quot;</span> <span class="o">%</span> <span class="n">basename</span>
      <span class="n">save_to_disk</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">out_w</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out_w</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">out_ids</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-ids.joblib&quot;</span> <span class="o">%</span> <span class="n">basename</span>
      <span class="n">save_to_disk</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">out_ids</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out_ids</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># note that this corresponds to the _construct_metadata column order</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">out_ids</span><span class="p">,</span> <span class="n">out_X</span><span class="p">,</span> <span class="n">out_y</span><span class="p">,</span> <span class="n">out_w</span><span class="p">]</span></div>

<div class="viewcode-block" id="DiskDataset.save_to_disk"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.save_to_disk">[docs]</a>  <span class="k">def</span> <span class="nf">save_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save dataset to disk.&quot;&quot;&quot;</span>
    <span class="n">save_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.move"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.move">[docs]</a>  <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Moves dataset to new directory.&quot;&quot;&quot;</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">new_data_dir</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">new_data_dir</span></div>

<div class="viewcode-block" id="DiskDataset.get_task_names"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.get_task_names">[docs]</a>  <span class="k">def</span> <span class="nf">get_task_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets learning tasks associated with this dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span></div>
    <span class="c1"># if not len(self.metadata_df):</span>
    <span class="c1">#  raise ValueError(&quot;No data in dataset.&quot;)</span>
    <span class="c1"># return next(self.metadata_df.iterrows())[1][&#39;task_names&#39;]</span>

<div class="viewcode-block" id="DiskDataset.reshard"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.reshard">[docs]</a>  <span class="k">def</span> <span class="nf">reshard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reshards data to have specified shard size.&quot;&quot;&quot;</span>
    <span class="c1"># Create temp directory to store resharded version</span>
    <span class="n">reshard_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">new_metadata</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Write data in new shards</span>
    <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
      <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_names</span><span class="p">()</span>
      <span class="n">X_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">())</span>
      <span class="n">y_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),))</span>
      <span class="n">w_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),))</span>
      <span class="n">ids_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itershards</span><span class="p">():</span>
        <span class="n">X_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X_next</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">y_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_next</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">w_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">w_next</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ids_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ids_next</span><span class="p">,</span> <span class="n">ids</span><span class="p">])</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_next</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">shard_size</span><span class="p">:</span>
          <span class="n">X_batch</span><span class="p">,</span> <span class="n">X_next</span> <span class="o">=</span> <span class="n">X_next</span><span class="p">[:</span><span class="n">shard_size</span><span class="p">],</span> <span class="n">X_next</span><span class="p">[</span><span class="n">shard_size</span><span class="p">:]</span>
          <span class="n">y_batch</span><span class="p">,</span> <span class="n">y_next</span> <span class="o">=</span> <span class="n">y_next</span><span class="p">[:</span><span class="n">shard_size</span><span class="p">],</span> <span class="n">y_next</span><span class="p">[</span><span class="n">shard_size</span><span class="p">:]</span>
          <span class="n">w_batch</span><span class="p">,</span> <span class="n">w_next</span> <span class="o">=</span> <span class="n">w_next</span><span class="p">[:</span><span class="n">shard_size</span><span class="p">],</span> <span class="n">w_next</span><span class="p">[</span><span class="n">shard_size</span><span class="p">:]</span>
          <span class="n">ids_batch</span><span class="p">,</span> <span class="n">ids_next</span> <span class="o">=</span> <span class="n">ids_next</span><span class="p">[:</span><span class="n">shard_size</span><span class="p">],</span> <span class="n">ids_next</span><span class="p">[</span><span class="n">shard_size</span><span class="p">:]</span>
          <span class="k">yield</span> <span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">w_batch</span><span class="p">,</span> <span class="n">ids_batch</span><span class="p">)</span>
      <span class="c1"># Handle spillover from last shard</span>
      <span class="k">yield</span> <span class="p">(</span><span class="n">X_next</span><span class="p">,</span> <span class="n">y_next</span><span class="p">,</span> <span class="n">w_next</span><span class="p">,</span> <span class="n">ids_next</span><span class="p">)</span>

    <span class="n">resharded_dataset</span> <span class="o">=</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
        <span class="n">generator</span><span class="p">(),</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">reshard_dir</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">reshard_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span> <span class="o">=</span> <span class="n">resharded_dataset</span><span class="o">.</span><span class="n">metadata_df</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">()</span></div>

<div class="viewcode-block" id="DiskDataset.get_data_shape"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.get_data_shape">[docs]</a>  <span class="k">def</span> <span class="nf">get_data_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets array shape of datapoints in this dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data in dataset.&quot;</span><span class="p">)</span>
    <span class="n">sample_X</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">())[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">sample_X</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span></div>

<div class="viewcode-block" id="DiskDataset.get_shard_size"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.get_shard_size">[docs]</a>  <span class="k">def</span> <span class="nf">get_shard_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets size of shards on disk.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data in dataset.&quot;</span><span class="p">)</span>
    <span class="n">sample_y</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">())[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_y</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_get_metadata_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get standard location for metadata file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;metadata.csv.gzip&quot;</span><span class="p">)</span>
    <span class="n">tasks_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;tasks.json&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tasks_filename</span><span class="p">,</span> <span class="n">metadata_filename</span>

<div class="viewcode-block" id="DiskDataset.get_number_shards"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.get_number_shards">[docs]</a>  <span class="k">def</span> <span class="nf">get_number_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the number of shards for this dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DiskDataset.itershards"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.itershards">[docs]</a>  <span class="k">def</span> <span class="nf">itershards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an object that iterates over all shards in dataset.</span>

<span class="sd">    Datasets are stored in sharded fashion on disk. Each call to next() for the</span>
<span class="sd">    generator defined by this function returns the data from a particular shard.</span>
<span class="sd">    The order of shards returned is guaranteed to remain fixed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">load_from_disk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">])))</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">load_from_disk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">])),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="c1"># These columns may be missing is the dataset is unlabelled.</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">load_from_disk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">y</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">w_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
          <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">w_filename</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">load_from_disk</span><span class="p">(</span><span class="n">w_filename</span><span class="p">))</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">w</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.iterbatches"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.iterbatches">[docs]</a>  <span class="k">def</span> <span class="nf">iterbatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">deterministic</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">pad_batches</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get an object that iterates over minibatches from the dataset. It is guaranteed</span>
<span class="sd">    that the number of batches returned is math.ceil(len(dataset)/batch_size).</span>
<span class="sd">    </span>
<span class="sd">    Each minibatch is returned as a tuple of four numpy arrays: (X, y, w, ids).</span>


<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    batch_size: int</span>
<span class="sd">      Number of elements in a batch. If None, then it yields batches with size equal to the size</span>
<span class="sd">      of each individual shard.</span>

<span class="sd">    epoch: int</span>
<span class="sd">      Not used</span>

<span class="sd">    deterministic: bool</span>
<span class="sd">      Whether or not we should should shuffle each shard before generating the batches.</span>
<span class="sd">      Note that this is only local in the sense that it does not ever mix between different</span>
<span class="sd">      shards.</span>

<span class="sd">    pad_batches: bool</span>
<span class="sd">      Whether or not we should pad the last batch, globally, such that it has exactly batch_size</span>
<span class="sd">      elements.</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
      <span class="n">num_shards</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_number_shards</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">deterministic</span><span class="p">:</span>
        <span class="n">shard_perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_shards</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">shard_perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_shards</span><span class="p">)</span>

      <span class="c1"># (ytz): Depending on the application, thread-based pools may be faster</span>
      <span class="c1"># than process based pools, since process based pools need to pickle/serialize</span>
      <span class="c1"># objects as an extra overhead. Also, as hideously as un-thread safe this looks,</span>
      <span class="c1"># we&#39;re actually protected by the GIL.</span>
      <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># mp.dummy aliases ThreadPool to Pool</span>
      <span class="n">next_shard</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_shard</span><span class="p">,</span> <span class="p">(</span><span class="n">shard_perm</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>

      <span class="n">total_yield</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">num_global_batches</span> <span class="o">=</span> <span class="n">num_shards</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">num_global_batches</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>

      <span class="n">cur_global_batch</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">cur_shard</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">carry</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="k">while</span> <span class="n">cur_global_batch</span> <span class="o">&lt;</span> <span class="n">num_global_batches</span><span class="p">:</span>

        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">next_shard</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cur_shard</span> <span class="o">&lt;</span> <span class="n">num_shards</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">next_shard</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_shard</span><span class="p">,</span>
                                        <span class="p">(</span><span class="n">shard_perm</span><span class="p">[</span><span class="n">cur_shard</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">carry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">carry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">carry</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">carry</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">w</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">carry</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ids</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">carry</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">n_shard_samples</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cur_local_batch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">shard_batch_size</span> <span class="o">=</span> <span class="n">n_shard_samples</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">shard_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>

        <span class="n">num_local_batches</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_shard_samples</span> <span class="o">/</span> <span class="n">shard_batch_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_shard_samples</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deterministic</span><span class="p">:</span>
          <span class="n">sample_perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n_shard_samples</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">sample_perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_shard_samples</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">cur_local_batch</span> <span class="o">&lt;</span> <span class="n">num_local_batches</span><span class="p">:</span>
          <span class="n">start</span> <span class="o">=</span> <span class="n">cur_local_batch</span> <span class="o">*</span> <span class="n">shard_batch_size</span>
          <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_shard_samples</span><span class="p">,</span> <span class="p">(</span><span class="n">cur_local_batch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">shard_batch_size</span><span class="p">)</span>

          <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
          <span class="n">perm_indices</span> <span class="o">=</span> <span class="n">sample_perm</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
          <span class="n">X_b</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">perm_indices</span><span class="p">]</span>

          <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">y_b</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">perm_indices</span><span class="p">]</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">y_b</span> <span class="o">=</span> <span class="bp">None</span>

          <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">w_b</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">perm_indices</span><span class="p">]</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">w_b</span> <span class="o">=</span> <span class="bp">None</span>

          <span class="n">ids_b</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">perm_indices</span><span class="p">]</span>

          <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_b</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">shard_batch_size</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">shard_batch_size</span> <span class="ow">and</span> <span class="n">cur_shard</span> <span class="o">!=</span> <span class="n">num_shards</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">carry</span> <span class="ow">is</span> <span class="bp">None</span>
            <span class="n">carry</span> <span class="o">=</span> <span class="p">[</span><span class="n">X_b</span><span class="p">,</span> <span class="n">y_b</span><span class="p">,</span> <span class="n">w_b</span><span class="p">,</span> <span class="n">ids_b</span><span class="p">]</span>
          <span class="k">else</span><span class="p">:</span>

            <span class="c1"># (ytz): this skips everything except possibly the last shard</span>
            <span class="k">if</span> <span class="n">pad_batches</span><span class="p">:</span>
              <span class="p">(</span><span class="n">X_b</span><span class="p">,</span> <span class="n">y_b</span><span class="p">,</span> <span class="n">w_b</span><span class="p">,</span> <span class="n">ids_b</span><span class="p">)</span> <span class="o">=</span> <span class="n">pad_batch</span><span class="p">(</span><span class="n">shard_batch_size</span><span class="p">,</span> <span class="n">X_b</span><span class="p">,</span> <span class="n">y_b</span><span class="p">,</span>
                                                 <span class="n">w_b</span><span class="p">,</span> <span class="n">ids_b</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">X_b</span><span class="p">,</span> <span class="n">y_b</span><span class="p">,</span> <span class="n">w_b</span><span class="p">,</span> <span class="n">ids_b</span>
            <span class="n">cur_global_batch</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">cur_local_batch</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">cur_shard</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.itersamples"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.itersamples">[docs]</a>  <span class="k">def</span> <span class="nf">itersamples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get an object that iterates over the samples in the dataset.</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; dataset = DiskDataset.from_numpy(np.ones((2,2)), np.ones((2,1)), verbose=False)</span>
<span class="sd">    &gt;&gt;&gt; for x, y, w, id in dataset.itersamples():</span>
<span class="sd">    ...   print(x, y, w, id)</span>
<span class="sd">    [ 1.  1.] [ 1.] [ 1.] 0</span>
<span class="sd">    [ 1.  1.] [ 1.] [ 1.] 1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">X_shard</span><span class="p">,</span> <span class="n">y_shard</span><span class="p">,</span> <span class="n">w_shard</span><span class="p">,</span> <span class="n">ids_shard</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">itershards</span><span class="p">():</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">X_shard</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>

          <span class="k">def</span> <span class="nf">sanitize</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
              <span class="k">return</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="k">return</span> <span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

          <span class="k">yield</span> <span class="nb">map</span><span class="p">(</span><span class="n">sanitize</span><span class="p">,</span> <span class="p">[</span><span class="n">X_shard</span><span class="p">,</span> <span class="n">y_shard</span><span class="p">,</span> <span class="n">w_shard</span><span class="p">,</span> <span class="n">ids_shard</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.transform"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.transform">[docs]</a>  <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a new dataset by applying a transformation to every sample in this dataset.</span>

<span class="sd">    The argument is a function that can be called as follows:</span>

<span class="sd">    &gt;&gt; newx, newy, neww = fn(x, y, w)</span>

<span class="sd">    It might be called only once with the whole dataset, or multiple times with different</span>
<span class="sd">    subsets of the data.  Each time it is called, it should transform the samples and return</span>
<span class="sd">    the transformed data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fn: function</span>
<span class="sd">      A function to apply to each sample in the dataset</span>
<span class="sd">    out_dir: string</span>
<span class="sd">      The directory to save the new dataset in.  If this is omitted, a temporary directory</span>
<span class="sd">      is created automatically</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    a newly constructed Dataset object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;out_dir&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
      <span class="n">out_dir</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;out_dir&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">shard_num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shard</span><span class="p">(</span><span class="n">shard_num</span><span class="p">)</span>
        <span class="n">newx</span><span class="p">,</span> <span class="n">newy</span><span class="p">,</span> <span class="n">neww</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">newy</span><span class="p">,</span> <span class="n">neww</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
        <span class="n">generator</span><span class="p">(),</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">)</span></div>

  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="DiskDataset.from_numpy"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.from_numpy">[docs]</a>  <span class="k">def</span> <span class="nf">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>
                 <span class="n">y</span><span class="p">,</span>
                 <span class="n">w</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">ids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">tasks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">data_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a DiskDataset object from specified Numpy arrays.&quot;&quot;&quot;</span>
    <span class="c1"># if data_dir is None:</span>
    <span class="c1">#  data_dir = tempfile.mkdtemp()</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="c1"># The -1 indicates that y will be reshaped to have length -1</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tasks</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">n_tasks</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">tasks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_tasks</span><span class="p">)</span>
    <span class="c1"># raw_data = (X, y, w, ids)</span>
    <span class="k">return</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)],</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="DiskDataset.merge"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.merge">[docs]</a>  <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">merge_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Merges provided datasets into a merged dataset.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">merge_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">merge_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">merge_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">merge_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">generator</span><span class="p">(),</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">merge_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.subset"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.subset">[docs]</a>  <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_nums</span><span class="p">,</span> <span class="n">subset_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a subset of the original dataset on disk.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">subset_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subset_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">subset_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">subset_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">shard_num</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">shard_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shard_nums</span><span class="p">:</span>
          <span class="k">continue</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shard</span><span class="p">(</span><span class="n">shard_num</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
        <span class="n">generator</span><span class="p">(),</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">subset_dir</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.sparse_shuffle"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.sparse_shuffle">[docs]</a>  <span class="k">def</span> <span class="nf">sparse_shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shuffling that exploits data sparsity to shuffle large datasets.</span>

<span class="sd">    Only for 1-dimensional feature vectors (does not work for tensorial</span>
<span class="sd">    featurizations).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">shard_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shard_size</span><span class="p">()</span>
    <span class="n">num_shards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_shards</span><span class="p">()</span>
    <span class="n">X_sparses</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">num_features</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_shards</span><span class="p">):</span>
      <span class="p">(</span><span class="n">X_s</span><span class="p">,</span> <span class="n">y_s</span><span class="p">,</span> <span class="n">w_s</span><span class="p">,</span> <span class="n">ids_s</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shard</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">num_features</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">num_features</span> <span class="o">=</span> <span class="n">X_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">X_sparse</span> <span class="o">=</span> <span class="n">sparsify_features</span><span class="p">(</span><span class="n">X_s</span><span class="p">)</span>
      <span class="n">X_sparses</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_sparses</span> <span class="o">+</span> <span class="p">[</span><span class="n">X_sparse</span><span class="p">],</span> <span class="n">ys</span> <span class="o">+</span> <span class="p">[</span><span class="n">y_s</span><span class="p">],</span> <span class="n">ws</span> <span class="o">+</span> <span class="p">[</span><span class="n">w_s</span><span class="p">],</span>
                                <span class="n">ids</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ids_s</span><span class="p">))])</span>
    <span class="c1"># Get full dataset in memory</span>
    <span class="p">(</span><span class="n">X_sparse</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">X_sparses</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ws</span><span class="p">),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
    <span class="c1"># Shuffle in memory</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_sparse</span><span class="p">)</span>
    <span class="n">permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)</span>
    <span class="n">X_sparse</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_sparse</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span>
                           <span class="n">w</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span> <span class="n">ids</span><span class="p">[</span><span class="n">permutation</span><span class="p">])</span>
    <span class="c1"># Write shuffled shards out to disk</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_shards</span><span class="p">):</span>
      <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">shard_size</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">shard_size</span>
      <span class="p">(</span><span class="n">X_sparse_s</span><span class="p">,</span> <span class="n">y_s</span><span class="p">,</span> <span class="n">w_s</span><span class="p">,</span> <span class="n">ids_s</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_sparse</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span>
                                       <span class="n">w</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">ids</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span>
      <span class="n">X_s</span> <span class="o">=</span> <span class="n">densify_features</span><span class="p">(</span><span class="n">X_sparse_s</span><span class="p">,</span> <span class="n">num_features</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">set_shard</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">X_s</span><span class="p">,</span> <span class="n">y_s</span><span class="p">,</span> <span class="n">w_s</span><span class="p">,</span> <span class="n">ids_s</span><span class="p">)</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;TIMING: sparse_shuffle took </span><span class="si">%0.3f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.shuffle_each_shard"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.shuffle_each_shard">[docs]</a>  <span class="k">def</span> <span class="nf">shuffle_each_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shuffles elements within each shard of the datset.&quot;&quot;&quot;</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_names</span><span class="p">()</span>
    <span class="c1"># Shuffle the arrays corresponding to each row in metadata_df</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span><span class="p">):</span>
      <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shard</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
      <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span>
                      <span class="n">ids</span><span class="p">[</span><span class="n">permutation</span><span class="p">])</span>
      <span class="n">DiskDataset</span><span class="o">.</span><span class="n">write_data_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.shuffle_shards"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.shuffle_shards">[docs]</a>  <span class="k">def</span> <span class="nf">shuffle_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shuffles the order of the shards for this dataset.&quot;&quot;&quot;</span>
    <span class="n">metadata_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">metadata_rows</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span> <span class="o">=</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">_construct_metadata</span><span class="p">(</span><span class="n">metadata_rows</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">()</span></div>

<div class="viewcode-block" id="DiskDataset.get_shard"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.get_shard">[docs]</a>  <span class="k">def</span> <span class="nf">get_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves data for the i-th shard from disk.&quot;&quot;&quot;</span>
    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">load_from_disk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">load_from_disk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">y</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1"># TODO (ytz): Under what condition does this exist but the file itself doesn&#39;t?</span>
      <span class="n">w_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">w_filename</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">load_from_disk</span><span class="p">(</span><span class="n">w_filename</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">load_from_disk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.add_shard"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.add_shard">[docs]</a>  <span class="k">def</span> <span class="nf">add_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds a data shard.&quot;&quot;&quot;</span>
    <span class="n">metadata_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">shard_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_rows</span><span class="p">)</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="s2">&quot;shard-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">shard_num</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_names</span><span class="p">()</span>
    <span class="n">metadata_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">DiskDataset</span><span class="o">.</span><span class="n">write_data_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span>
                                       <span class="n">ids</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span> <span class="o">=</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">_construct_metadata</span><span class="p">(</span><span class="n">metadata_rows</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">()</span></div>

<div class="viewcode-block" id="DiskDataset.set_shard"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.set_shard">[docs]</a>  <span class="k">def</span> <span class="nf">set_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_num</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes data shard to disk&quot;&quot;&quot;</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="s2">&quot;shard-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">shard_num</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_names</span><span class="p">()</span>
    <span class="n">DiskDataset</span><span class="o">.</span><span class="n">write_data_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.select"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.select">[docs]</a>  <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">select_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new dataset from a selection of indices from self.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    select_dir: string</span>
<span class="sd">      Path to new directory that the selected indices will be copied to.</span>
<span class="sd">    indices: list</span>
<span class="sd">      List of indices to select.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">select_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">select_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">select_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">select_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="c1"># Handle edge case with empty indices</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
          <span class="p">[],</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">select_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
      <span class="n">count</span><span class="p">,</span> <span class="n">indices_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">shard_num</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itershards</span><span class="p">()):</span>
        <span class="n">shard_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="c1"># Find indices which rest in this shard</span>
        <span class="n">num_shard_elts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">indices</span><span class="p">[</span><span class="n">indices_count</span> <span class="o">+</span> <span class="n">num_shard_elts</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">+</span> <span class="n">shard_len</span><span class="p">:</span>
          <span class="n">num_shard_elts</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">if</span> <span class="n">indices_count</span> <span class="o">+</span> <span class="n">num_shard_elts</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="c1"># Need to offset indices to fit within shard_size</span>
        <span class="n">shard_inds</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">indices_count</span><span class="p">:</span>
                             <span class="n">indices_count</span> <span class="o">+</span> <span class="n">num_shard_elts</span><span class="p">]</span> <span class="o">-</span> <span class="n">count</span>
        <span class="n">X_sel</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">shard_inds</span><span class="p">]</span>
        <span class="c1"># Handle the case of datasets with y/w missing</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">y_sel</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">shard_inds</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">y_sel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">w_sel</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">shard_inds</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">w_sel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ids_sel</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">shard_inds</span><span class="p">]</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">X_sel</span><span class="p">,</span> <span class="n">y_sel</span><span class="p">,</span> <span class="n">w_sel</span><span class="p">,</span> <span class="n">ids_sel</span><span class="p">)</span>
        <span class="c1"># Updating counts</span>
        <span class="n">indices_count</span> <span class="o">+=</span> <span class="n">num_shard_elts</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">shard_len</span>
        <span class="c1"># Break when all indices have been used up already</span>
        <span class="k">if</span> <span class="n">indices_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
          <span class="k">return</span>

    <span class="k">return</span> <span class="n">DiskDataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
        <span class="n">generator</span><span class="p">(),</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">select_dir</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span></div>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the ids vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ids_b</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itershards</span><span class="p">():</span>
      <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ids_b</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the X vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="n">Xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">one_dimensional</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">X_b</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itershards</span><span class="p">():</span>
      <span class="n">Xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_b</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">one_dimensional</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">one_dimensional</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the y vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">y_b</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itershards</span><span class="p">():</span>
      <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">w</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the weight vector for this dataset as a single numpy array.&quot;&quot;&quot;</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">w_b</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itershards</span><span class="p">():</span>
      <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w_b</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>

<div class="viewcode-block" id="DiskDataset.__len__"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.__len__">[docs]</a>  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds number of elements in dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]))</span>
      <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total</span></div>

<div class="viewcode-block" id="DiskDataset.get_shape"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.get_shape">[docs]</a>  <span class="k">def</span> <span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds shape of dataset.&quot;&quot;&quot;</span>
    <span class="n">n_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_task_names</span><span class="p">())</span>
    <span class="n">X_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()))</span>
    <span class="n">ids_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">n_tasks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">y_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
      <span class="n">w_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">y_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
      <span class="n">w_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">shard_num</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itershards</span><span class="p">()):</span>
      <span class="k">if</span> <span class="n">shard_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">X_shape</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_tasks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">y_shape</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
          <span class="n">w_shape</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ids_shape</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">X_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_tasks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">y_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">w_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ids_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">X_shape</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">y_shape</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">w_shape</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids_shape</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiskDataset.get_label_means"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.get_label_means">[docs]</a>  <span class="k">def</span> <span class="nf">get_label_means</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return pandas series of label means.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="p">[</span><span class="s2">&quot;y_means&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DiskDataset.get_label_stds"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.DiskDataset.get_label_stds">[docs]</a>  <span class="k">def</span> <span class="nf">get_label_stds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return pandas series of label stds.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="p">[</span><span class="s2">&quot;y_stds&quot;</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="Databag"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Databag">[docs]</a><span class="k">class</span> <span class="nc">Databag</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A utility class to iterate through multiple datasets together.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">datasets</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>

<div class="viewcode-block" id="Databag.add_dataset"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Databag.add_dataset">[docs]</a>  <span class="k">def</span> <span class="nf">add_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span></div>

<div class="viewcode-block" id="Databag.iterbatches"><a class="viewcode-back" href="../../../deepchem.data.html#deepchem.data.datasets.Databag.iterbatches">[docs]</a>  <span class="k">def</span> <span class="nf">iterbatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loop through all internal datasets in the same order</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    batch_size: int</span>
<span class="sd">      Number of samples from each dataset to return</span>
<span class="sd">    epoch: int</span>
<span class="sd">      Number of times to loop through the datasets</span>
<span class="sd">    pad_batches: boolean</span>
<span class="sd">      Should all batches==batch_size</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Generator which yields a dictionary {key: dataset.X[batch]}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="k">if</span> <span class="s2">&quot;epochs&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
      <span class="n">epochs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span>
      <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;deterministic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
      <span class="n">iterators</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">iterbatches</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key_order</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterators</span><span class="p">):</span>
        <span class="n">m_d</span> <span class="o">=</span> <span class="p">{</span><span class="n">key_order</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">tup</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key_order</span><span class="p">))}</span>
        <span class="k">yield</span> <span class="n">m_d</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016, Stanford University and the Authors.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>