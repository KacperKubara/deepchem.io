<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>deepchem.feat.rdkit_grid_featurizer &mdash; deepchem 1.3.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.3.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="deepchem 1.3.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-inverse navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><span><img src="../../../_static/logo.png"></span>
          deepchem</a>
        <span class="navbar-text navbar-version pull-left"><b>1.3</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../notebooks/index.html">Notebooks</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../deepchem.html">deepchem package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for deepchem.feat.rdkit_grid_featurizer</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Bharath Ramsundar, Evan Feinberg, and Karl Leswing&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2016, Stanford University&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span>
<span class="kn">from</span> <span class="nn">deepchem.utils.rdkit_util</span> <span class="kn">import</span> <span class="n">load_molecule</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">deepchem.feat</span> <span class="kn">import</span> <span class="n">ComplexFeaturizer</span>
<span class="kn">from</span> <span class="nn">deepchem.utils.save</span> <span class="kn">import</span> <span class="n">log</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TODO(LESWING) add sanitization with rdkit upgrade to 2017.*</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="get_ligand_filetype"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.get_ligand_filetype">[docs]</a><span class="k">def</span> <span class="nf">get_ligand_filetype</span><span class="p">(</span><span class="n">ligand_filename</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the filetype of ligand.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="s2">&quot;.mol2&quot;</span> <span class="ow">in</span> <span class="n">ligand_filename</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;mol2&quot;</span>
  <span class="k">elif</span> <span class="s2">&quot;.sdf&quot;</span> <span class="ow">in</span> <span class="n">ligand_filename</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;sdf&quot;</span>
  <span class="k">elif</span> <span class="s2">&quot;.pdbqt&quot;</span> <span class="ow">in</span> <span class="n">ligand_filename</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;pdbqt&quot;</span>
  <span class="k">elif</span> <span class="s2">&quot;.pdb&quot;</span> <span class="ow">in</span> <span class="n">ligand_filename</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;pdb&quot;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized_filename&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_centroid"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_centroid">[docs]</a><span class="k">def</span> <span class="nf">compute_centroid</span><span class="p">(</span><span class="n">coordinates</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Compute the x,y,z centroid of provided coordinates</span>

<span class="sd">  coordinates: np.ndarray</span>
<span class="sd">    Shape (N, 3), where N is number atoms.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">centroid</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_random__unit_vector"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.generate_random__unit_vector">[docs]</a><span class="k">def</span> <span class="nf">generate_random__unit_vector</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;Generate a random unit vector on the 3-sphere.</span>
<span class="sd">  citation:</span>
<span class="sd">  http://mathworld.wolfram.com/SpherePointPicking.html</span>

<span class="sd">  a. Choose random theta \element [0, 2*pi]</span>
<span class="sd">  b. Choose random z \element [-1, 1]</span>
<span class="sd">  c. Compute output vector u: (x,y,z) = (sqrt(1-z^2)*cos(theta), sqrt(1-z^2)*sin(theta),z)</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
  <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
      <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
       <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">z</span><span class="p">])</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_random_rotation_matrix"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.generate_random_rotation_matrix">[docs]</a><span class="k">def</span> <span class="nf">generate_random_rotation_matrix</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1. Generate a random unit vector u, randomly sampled from the unit</span>
<span class="sd">      3-sphere (see function generate_random__unit_vector() for details)</span>
<span class="sd">    2. Generate a second random unit vector v</span>
<span class="sd">      a. If absolute value of u \dot v &gt; 0.99, repeat.</span>
<span class="sd">       (This is important for numerical stability. Intuition: we want them to</span>
<span class="sd">        be as linearly independent as possible or else the orthogonalized</span>
<span class="sd">        version of v will be much shorter in magnitude compared to u. I assume</span>
<span class="sd">        in Stack they took this from Gram-Schmidt orthogonalization?)</span>
<span class="sd">      b. v&quot; = v - (u \dot v)*u, i.e. subtract out the component of v that&#39;s in</span>
<span class="sd">       u&#39;s direction</span>
<span class="sd">      c. normalize v&quot; (this isn&quot;t in Stack but I assume it must be done)</span>
<span class="sd">    3. find w = u \cross v&quot;</span>
<span class="sd">    4. u, v&quot;, and w will form the columns of a rotation matrix, R. The</span>
<span class="sd">       intuition is that u, v&quot; and w are, respectively, what the standard basis</span>
<span class="sd">       vectors e1, e2, and e3 will be mapped to under the transformation.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">u</span> <span class="o">=</span> <span class="n">generate_random__unit_vector</span><span class="p">()</span>
  <span class="n">v</span> <span class="o">=</span> <span class="n">generate_random__unit_vector</span><span class="p">()</span>
  <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mf">0.99</span><span class="p">:</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">generate_random__unit_vector</span><span class="p">()</span>

  <span class="n">vp</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
  <span class="n">vp</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vp</span><span class="p">)</span>

  <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">vp</span><span class="p">)</span>

  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span></div>


<div class="viewcode-block" id="rotate_molecules"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.rotate_molecules">[docs]</a><span class="k">def</span> <span class="nf">rotate_molecules</span><span class="p">(</span><span class="n">mol_coordinates_list</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Rotates provided molecular coordinates.</span>

<span class="sd">  Pseudocode:</span>
<span class="sd">  1. Generate random rotation matrix. This matrix applies a random</span>
<span class="sd">     transformation to any 3-vector such that, were the random transformation</span>
<span class="sd">     repeatedly applied, it would randomly sample along the surface of a sphere</span>
<span class="sd">     with radius equal to the norm of the given 3-vector cf.</span>
<span class="sd">     _generate_random_rotation_matrix() for details</span>
<span class="sd">  2. Apply R to all atomic coordinatse.</span>
<span class="sd">  3. Return rotated molecule</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">generate_random_rotation_matrix</span><span class="p">()</span>
  <span class="n">rotated_coordinates_list</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">for</span> <span class="n">mol_coordinates</span> <span class="ow">in</span> <span class="n">mol_coordinates_list</span><span class="p">:</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mol_coordinates</span><span class="p">)</span>
    <span class="n">rotated_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)))</span>
    <span class="n">rotated_coordinates_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotated_coordinates</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">rotated_coordinates_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_pairwise_distances"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_pairwise_distances">[docs]</a><span class="k">def</span> <span class="nf">compute_pairwise_distances</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Takes an input m x 3 and n x 3 np arrays of 3D coords of protein and ligand,</span>
<span class="sd">  respectively, and outputs an m x n np array of pairwise distances in Angstroms</span>
<span class="sd">  between protein and ligand atoms. entry (i,j) is dist between the i&quot;th protein</span>
<span class="sd">  atom and the j&quot;th ligand atom.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">pairwise_distances</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">pairwise_distances</span><span class="p">)</span></div>


<span class="sd">&quot;&quot;&quot;following two functions adapted from:</span>
<span class="sd">http://stackoverflow.com/questions/2827393/angles-between-two-n-dimensional-vectors-in-python</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="unit_vector"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.unit_vector">[docs]</a><span class="k">def</span> <span class="nf">unit_vector</span><span class="p">(</span><span class="n">vector</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Returns the unit vector of the vector.  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">vector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span></div>


<div class="viewcode-block" id="angle_between"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.angle_between">[docs]</a><span class="k">def</span> <span class="nf">angle_between</span><span class="p">(</span><span class="n">vector_i</span><span class="p">,</span> <span class="n">vector_j</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the angle in radians between vectors &quot;vector_i&quot; and &quot;vector_j&quot;::</span>

<span class="sd">  &gt;&gt;&gt; print(&quot;%0.06f&quot; % angle_between((1, 0, 0), (0, 1, 0)))</span>
<span class="sd">  1.570796</span>
<span class="sd">  &gt;&gt;&gt; print(&quot;%0.06f&quot; % angle_between((1, 0, 0), (1, 0, 0)))</span>
<span class="sd">  0.000000</span>
<span class="sd">  &gt;&gt;&gt; print(&quot;%0.06f&quot; % angle_between((1, 0, 0), (-1, 0, 0)))</span>
<span class="sd">  3.141593</span>

<span class="sd">  Note that this function always returns the smaller of the two angles between</span>
<span class="sd">  the vectors (value between 0 and pi).</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">vector_i_u</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">vector_i</span><span class="p">)</span>
  <span class="n">vector_j_u</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">vector_j</span><span class="p">)</span>
  <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vector_i_u</span><span class="p">,</span> <span class="n">vector_j_u</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">vector_i_u</span><span class="p">,</span> <span class="n">vector_j_u</span><span class="p">):</span>
      <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
  <span class="k">return</span> <span class="n">angle</span></div>


<div class="viewcode-block" id="hash_sybyl"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.hash_sybyl">[docs]</a><span class="k">def</span> <span class="nf">hash_sybyl</span><span class="p">(</span><span class="n">sybyl</span><span class="p">,</span> <span class="n">sybyl_types</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">sybyl_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sybyl</span><span class="p">))</span></div>


<div class="viewcode-block" id="hash_ecfp"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.hash_ecfp">[docs]</a><span class="k">def</span> <span class="nf">hash_ecfp</span><span class="p">(</span><span class="n">ecfp</span><span class="p">,</span> <span class="n">power</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Returns an int of size 2^power representing that</span>
<span class="sd">  ECFP fragment. Input must be a string.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">ecfp</span> <span class="o">=</span> <span class="n">ecfp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
  <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
  <span class="n">md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ecfp</span><span class="p">)</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
  <span class="n">ecfp_hash</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ecfp_hash</span><span class="p">)</span></div>


<div class="viewcode-block" id="hash_ecfp_pair"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.hash_ecfp_pair">[docs]</a><span class="k">def</span> <span class="nf">hash_ecfp_pair</span><span class="p">(</span><span class="n">ecfp_pair</span><span class="p">,</span> <span class="n">power</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns an int of size 2^power representing that ECFP pair. Input must be</span>
<span class="sd">  a tuple of strings.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">ecfp</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ecfp_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ecfp_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="n">ecfp</span> <span class="o">=</span> <span class="n">ecfp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
  <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
  <span class="n">md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ecfp</span><span class="p">)</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
  <span class="n">ecfp_hash</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ecfp_hash</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_all_ecfp"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_all_ecfp">[docs]</a><span class="k">def</span> <span class="nf">compute_all_ecfp</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Obtain molecular fragment for all atoms emanating outward to given degree.</span>
<span class="sd">  For each fragment, compute SMILES string (for now) and hash to an int.</span>
<span class="sd">  Return a dictionary mapping atom index to hashed SMILES.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">ecfp_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
      <span class="k">continue</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">FindAtomEnvironmentOfRadiusN</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">useHs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">submol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">PathToSubmol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="n">smile</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">submol</span><span class="p">)</span>
    <span class="n">ecfp_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">(),</span> <span class="n">smile</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">ecfp_dict</span></div>


<div class="viewcode-block" id="compute_ecfp_features"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_ecfp_features">[docs]</a><span class="k">def</span> <span class="nf">compute_ecfp_features</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">ecfp_degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ecfp_power</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes ECFP features for provided rdkit molecule.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    mol: rdkit molecule</span>
<span class="sd">      Molecule to featurize.</span>
<span class="sd">    ecfp_degree: int</span>
<span class="sd">      ECFP radius</span>
<span class="sd">    ecfp_power: int</span>
<span class="sd">      Number of bits to store ECFP features (2^ecfp_power will be length of</span>
<span class="sd">      ECFP array)</span>
<span class="sd">  Returns:</span>
<span class="sd">  --------</span>
<span class="sd">    ecfp_array: np.ndarray</span>
<span class="sd">      Returns an array of size 2^ecfp_power where array at index i has a 1 if</span>
<span class="sd">      that ECFP fragment is found in the molecule and array at index j has a 0</span>
<span class="sd">      if ECFP fragment not in molecule.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">bv</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganFingerprintAsBitVect</span><span class="p">(</span>
      <span class="n">mol</span><span class="p">,</span> <span class="n">ecfp_degree</span><span class="p">,</span> <span class="n">nBits</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">ecfp_power</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bv</span><span class="p">)</span></div>


<div class="viewcode-block" id="featurize_binding_pocket_ecfp"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.featurize_binding_pocket_ecfp">[docs]</a><span class="k">def</span> <span class="nf">featurize_binding_pocket_ecfp</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span>
                                  <span class="n">protein</span><span class="p">,</span>
                                  <span class="n">ligand_xyz</span><span class="p">,</span>
                                  <span class="n">ligand</span><span class="p">,</span>
                                  <span class="n">pairwise_distances</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                  <span class="n">cutoff</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span>
                                  <span class="n">ecfp_degree</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes ECFP dicts for ligand and binding pocket of the protein.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  protein_xyz: np.ndarray</span>
<span class="sd">    Of shape (N_protein_atoms, 3)</span>
<span class="sd">  protein: rdkit.rdchem.Mol</span>
<span class="sd">    Contains more metadata.</span>
<span class="sd">  ligand_xyz: np.ndarray</span>
<span class="sd">    Of shape (N_ligand_atoms, 3)</span>
<span class="sd">  ligand: rdkit.rdchem.Mol</span>
<span class="sd">    Contains more metadata</span>
<span class="sd">  pairwise_distances: np.ndarray</span>
<span class="sd">    Array of pairwise protein-ligand distances (Angstroms)</span>
<span class="sd">  cutoff: float</span>
<span class="sd">    Cutoff distance for contact consideration</span>
<span class="sd">  ecfp_degree: int</span>
<span class="sd">    ECFP radius</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="n">pairwise_distances</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">pairwise_distances</span> <span class="o">=</span> <span class="n">compute_pairwise_distances</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">)</span>
  <span class="n">contacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">pairwise_distances</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">))</span>
  <span class="n">protein_atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>

  <span class="n">protein_ecfp_dict</span> <span class="o">=</span> <span class="n">compute_all_ecfp</span><span class="p">(</span>
      <span class="n">protein</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">protein_atoms</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">ecfp_degree</span><span class="p">)</span>
  <span class="n">ligand_ecfp_dict</span> <span class="o">=</span> <span class="n">compute_all_ecfp</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">ecfp_degree</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">protein_ecfp_dict</span><span class="p">,</span> <span class="n">ligand_ecfp_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_all_sybyl"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_all_sybyl">[docs]</a><span class="k">def</span> <span class="nf">compute_all_sybyl</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes Sybyl atom types for atoms in molecule.&quot;&quot;&quot;</span>
  <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This function is not implemented yet&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="featurize_binding_pocket_sybyl"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.featurize_binding_pocket_sybyl">[docs]</a><span class="k">def</span> <span class="nf">featurize_binding_pocket_sybyl</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span>
                                   <span class="n">protein</span><span class="p">,</span>
                                   <span class="n">ligand_xyz</span><span class="p">,</span>
                                   <span class="n">ligand</span><span class="p">,</span>
                                   <span class="n">pairwise_distances</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                   <span class="n">cutoff</span><span class="o">=</span><span class="mf">7.0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes Sybyl dicts for ligand and binding pocket of the protein.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  protein_xyz: np.ndarray</span>
<span class="sd">    Of shape (N_protein_atoms, 3)</span>
<span class="sd">  protein: Rdkit Molecule</span>
<span class="sd">    Contains more metadata.</span>
<span class="sd">  ligand_xyz: np.ndarray</span>
<span class="sd">    Of shape (N_ligand_atoms, 3)</span>
<span class="sd">  ligand: Rdkit Molecule</span>
<span class="sd">    Contains more metadata</span>
<span class="sd">  pairwise_distances: np.ndarray</span>
<span class="sd">    Array of pairwise protein-ligand distances (Angstroms)</span>
<span class="sd">  cutoff: float</span>
<span class="sd">    Cutoff distance for contact consideration.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">features_dict</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">if</span> <span class="n">pairwise_distances</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">pairwise_distances</span> <span class="o">=</span> <span class="n">compute_pairwise_distances</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">)</span>
  <span class="n">contacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">pairwise_distances</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">))</span>
  <span class="n">protein_atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>

  <span class="n">protein_sybyl_dict</span> <span class="o">=</span> <span class="n">compute_all_sybyl</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">protein_atoms</span><span class="p">)</span>
  <span class="n">ligand_sybyl_dict</span> <span class="o">=</span> <span class="n">compute_all_sybyl</span><span class="p">(</span><span class="n">ligand</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">protein_sybyl_dict</span><span class="p">,</span> <span class="n">ligand_sybyl_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_splif_features_in_range"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_splif_features_in_range">[docs]</a><span class="k">def</span> <span class="nf">compute_splif_features_in_range</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span>
                                    <span class="n">ligand</span><span class="p">,</span>
                                    <span class="n">pairwise_distances</span><span class="p">,</span>
                                    <span class="n">contact_bin</span><span class="p">,</span>
                                    <span class="n">ecfp_degree</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes SPLIF features for protein atoms close to ligand atoms.</span>

<span class="sd">  Finds all protein atoms that are &gt; contact_bin[0] and &lt; contact_bin[1] away</span>
<span class="sd">  from ligand atoms. Then, finds the ECFP fingerprints for the contacting</span>
<span class="sd">  atoms. Returns a dictionary mapping (protein_index_i, ligand_index_j) --&gt;</span>
<span class="sd">  (protein_ecfp_i, ligand_ecfp_j)</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">contacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">pairwise_distances</span> <span class="o">&gt;</span> <span class="n">contact_bin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">pairwise_distances</span> <span class="o">&lt;</span> <span class="n">contact_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
  <span class="n">protein_atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
  <span class="n">contacts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contacts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">contacts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

  <span class="n">protein_ecfp_dict</span> <span class="o">=</span> <span class="n">compute_all_ecfp</span><span class="p">(</span>
      <span class="n">protein</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">protein_atoms</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">ecfp_degree</span><span class="p">)</span>
  <span class="n">ligand_ecfp_dict</span> <span class="o">=</span> <span class="n">compute_all_ecfp</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">ecfp_degree</span><span class="p">)</span>
  <span class="n">splif_dict</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">contact</span><span class="p">:</span> <span class="p">(</span><span class="n">protein_ecfp_dict</span><span class="p">[</span><span class="n">contact</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ligand_ecfp_dict</span><span class="p">[</span><span class="n">contact</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
      <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">splif_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="featurize_splif"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.featurize_splif">[docs]</a><span class="k">def</span> <span class="nf">featurize_splif</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">contact_bins</span><span class="p">,</span>
                    <span class="n">pairwise_distances</span><span class="p">,</span> <span class="n">ecfp_degree</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes SPLIF featurization of protein-ligand binding pocket.</span>

<span class="sd">  For each contact range (i.e. 1 A to 2 A, 2 A to 3 A, etc.) compute a</span>
<span class="sd">  dictionary mapping (protein_index_i, ligand_index_j) tuples --&gt;</span>
<span class="sd">  (protein_ecfp_i, ligand_ecfp_j) tuples. Return a list of such splif</span>
<span class="sd">  dictionaries.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">splif_dicts</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">contact_bin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contact_bins</span><span class="p">):</span>
    <span class="n">splif_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">compute_splif_features_in_range</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">pairwise_distances</span><span class="p">,</span>
                                        <span class="n">contact_bin</span><span class="p">,</span> <span class="n">ecfp_degree</span><span class="p">))</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">splif_dicts</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_ring_center"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_ring_center">[docs]</a><span class="k">def</span> <span class="nf">compute_ring_center</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">ring_indices</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes 3D coordinates of a center of a given ring.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    mol: rdkit.rdchem.Mol</span>
<span class="sd">      Molecule containing a ring</span>
<span class="sd">    ring_indices: array-like</span>
<span class="sd">      Indices of atoms forming a ring</span>

<span class="sd">  Returns:</span>
<span class="sd">  --------</span>
<span class="sd">    ring_centroid: np.ndarray</span>
<span class="sd">      Position of a ring center</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">conformer</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>
  <span class="n">ring_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ring_indices</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ring_indices</span><span class="p">):</span>
    <span class="n">atom_position</span> <span class="o">=</span> <span class="n">conformer</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)</span>
    <span class="n">ring_xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom_position</span><span class="p">)</span>
  <span class="n">ring_centroid</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">ring_xyz</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">ring_centroid</span></div>


<div class="viewcode-block" id="compute_ring_normal"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_ring_normal">[docs]</a><span class="k">def</span> <span class="nf">compute_ring_normal</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">ring_indices</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes normal to a plane determined by a given ring.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    mol: rdkit.rdchem.Mol</span>
<span class="sd">      Molecule containing a ring</span>
<span class="sd">    ring_indices: array-like</span>
<span class="sd">      Indices of atoms forming a ring</span>

<span class="sd">  Returns:</span>
<span class="sd">  --------</span>
<span class="sd">    normal: np.ndarray</span>
<span class="sd">      Normal vector</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">conformer</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>
  <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ring_indices</span><span class="p">[:</span><span class="mi">3</span><span class="p">]):</span>
    <span class="n">atom_position</span> <span class="o">=</span> <span class="n">conformer</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)</span>
    <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom_position</span><span class="p">)</span>

  <span class="n">v1</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">normal</span></div>


<div class="viewcode-block" id="is_pi_parallel"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.is_pi_parallel">[docs]</a><span class="k">def</span> <span class="nf">is_pi_parallel</span><span class="p">(</span><span class="n">ring1_center</span><span class="p">,</span>
                   <span class="n">ring1_normal</span><span class="p">,</span>
                   <span class="n">ring2_center</span><span class="p">,</span>
                   <span class="n">ring2_normal</span><span class="p">,</span>
                   <span class="n">dist_cutoff</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span>
                   <span class="n">angle_cutoff</span><span class="o">=</span><span class="mf">30.0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Check if two aromatic rings form a parallel pi-pi contact.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    ring1_center, ring2_center: np.ndarray</span>
<span class="sd">      Positions of centers of the two rings. Can be computed with the</span>
<span class="sd">      compute_ring_center function.</span>
<span class="sd">    ring1_normal, ring2_normal: np.ndarray</span>
<span class="sd">      Normals of the two rings. Can be computed with the compute_ring_normal</span>
<span class="sd">      function.</span>
<span class="sd">    dist_cutoff: float</span>
<span class="sd">      Distance cutoff. Max allowed distance between the ring center (Angstroms).</span>
<span class="sd">    angle_cutoff: float</span>
<span class="sd">      Angle cutoff. Max allowed deviation from the ideal (0deg) angle between</span>
<span class="sd">      the rings (in degrees).</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ring1_center</span> <span class="o">-</span> <span class="n">ring2_center</span><span class="p">)</span>
  <span class="n">angle</span> <span class="o">=</span> <span class="n">angle_between</span><span class="p">(</span><span class="n">ring1_normal</span><span class="p">,</span> <span class="n">ring2_normal</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="n">angle_cutoff</span> <span class="ow">or</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mf">180.0</span> <span class="o">-</span> <span class="n">angle_cutoff</span><span class="p">)</span> <span class="ow">and</span>
      <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_cutoff</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">return</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="is_pi_t"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.is_pi_t">[docs]</a><span class="k">def</span> <span class="nf">is_pi_t</span><span class="p">(</span><span class="n">ring1_center</span><span class="p">,</span>
            <span class="n">ring1_normal</span><span class="p">,</span>
            <span class="n">ring2_center</span><span class="p">,</span>
            <span class="n">ring2_normal</span><span class="p">,</span>
            <span class="n">dist_cutoff</span><span class="o">=</span><span class="mf">5.5</span><span class="p">,</span>
            <span class="n">angle_cutoff</span><span class="o">=</span><span class="mf">30.0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Check if two aromatic rings form a T-shaped pi-pi contact.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    ring1_center, ring2_center: np.ndarray</span>
<span class="sd">      Positions of centers of the two rings. Can be computed with the</span>
<span class="sd">      compute_ring_center function.</span>
<span class="sd">    ring1_normal, ring2_normal: np.ndarray</span>
<span class="sd">      Normals of the two rings. Can be computed with the compute_ring_normal</span>
<span class="sd">      function.</span>
<span class="sd">    dist_cutoff: float</span>
<span class="sd">      Distance cutoff. Max allowed distance between the ring center (Angstroms).</span>
<span class="sd">    angle_cutoff: float</span>
<span class="sd">      Angle cutoff. Max allowed deviation from the ideal (90deg) angle between</span>
<span class="sd">      the rings (in degrees).</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ring1_center</span> <span class="o">-</span> <span class="n">ring2_center</span><span class="p">)</span>
  <span class="n">angle</span> <span class="o">=</span> <span class="n">angle_between</span><span class="p">(</span><span class="n">ring1_normal</span><span class="p">,</span> <span class="n">ring2_normal</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
  <span class="k">if</span> <span class="p">((</span><span class="mf">90.0</span> <span class="o">-</span> <span class="n">angle_cutoff</span> <span class="o">&lt;</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="mf">90.0</span> <span class="o">+</span> <span class="n">angle_cutoff</span><span class="p">)</span> <span class="ow">and</span>
      <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_cutoff</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">return</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="compute_pi_stack"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_pi_stack">[docs]</a><span class="k">def</span> <span class="nf">compute_pi_stack</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span>
                     <span class="n">ligand</span><span class="p">,</span>
                     <span class="n">pairwise_distances</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">dist_cutoff</span><span class="o">=</span><span class="mf">4.4</span><span class="p">,</span>
                     <span class="n">angle_cutoff</span><span class="o">=</span><span class="mf">30.</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Find aromatic rings in protein and ligand that form pi-pi contacts.</span>
<span class="sd">  For each atom in the contact, count number of atoms in the other molecule</span>
<span class="sd">  that form this contact.</span>

<span class="sd">  Pseudocode:</span>

<span class="sd">  for each aromatic ring in protein:</span>
<span class="sd">    for each aromatic ring in ligand:</span>
<span class="sd">      compute distance between centers</span>
<span class="sd">      compute angle between normals</span>
<span class="sd">      if it counts as parallel pi-pi:</span>
<span class="sd">        count interacting atoms</span>
<span class="sd">      if it counts as pi-T:</span>
<span class="sd">        count interacting atoms</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    protein, ligand: rdkit.rdchem.Mol</span>
<span class="sd">      Two interacting molecules.</span>
<span class="sd">    pairwise_distances: np.ndarray (optional)</span>
<span class="sd">      Array of pairwise protein-ligand distances (Angstroms)</span>
<span class="sd">    dist_cutoff: float</span>
<span class="sd">      Distance cutoff. Max allowed distance between the ring center (Angstroms).</span>
<span class="sd">    angle_cutoff: float</span>
<span class="sd">      Angle cutoff. Max allowed deviation from the ideal angle between rings.</span>

<span class="sd">  Returns:</span>
<span class="sd">  --------</span>
<span class="sd">    protein_pi_t, protein_pi_parallel, ligand_pi_t, ligand_pi_parallel: dict</span>
<span class="sd">      Dictionaries mapping atom indices to number of atoms they interact with.</span>
<span class="sd">      Separate dictionary is created for each type of pi stacking (parallel and</span>
<span class="sd">      T-shaped) and each molecule (protein and ligand).</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">protein_pi_parallel</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
  <span class="n">protein_pi_t</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
  <span class="n">ligand_pi_parallel</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
  <span class="n">ligand_pi_t</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>

  <span class="n">protein_aromatic_rings</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">ligand_aromatic_rings</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">mol</span><span class="p">,</span> <span class="n">ring_list</span> <span class="ow">in</span> <span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="n">protein_aromatic_rings</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="n">ligand_aromatic_rings</span><span class="p">)):</span>
    <span class="n">aromatic_atoms</span> <span class="o">=</span> <span class="p">{</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAromaticAtoms</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">Chem</span><span class="o">.</span><span class="n">GetSymmSSSR</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
      <span class="c1"># if ring is aromatic</span>
      <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">aromatic_atoms</span><span class="p">):</span>
        <span class="c1"># save its indices, center, and normal</span>
        <span class="n">ring_center</span> <span class="o">=</span> <span class="n">compute_ring_center</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">ring</span><span class="p">)</span>
        <span class="n">ring_normal</span> <span class="o">=</span> <span class="n">compute_ring_normal</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">ring</span><span class="p">)</span>
        <span class="n">ring_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ring</span><span class="p">,</span> <span class="n">ring_center</span><span class="p">,</span> <span class="n">ring_normal</span><span class="p">))</span>

  <span class="c1"># remember protein-ligand pairs we already counted</span>
  <span class="n">counted_pairs_parallel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
  <span class="n">counted_pairs_t</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">prot_ring</span><span class="p">,</span> <span class="n">prot_ring_center</span><span class="p">,</span> <span class="n">prot_ring_normal</span> <span class="ow">in</span> <span class="n">protein_aromatic_rings</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">lig_ring</span><span class="p">,</span> <span class="n">lig_ring_center</span><span class="p">,</span> <span class="n">lig_ring_normal</span> <span class="ow">in</span> <span class="n">ligand_aromatic_rings</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">is_pi_parallel</span><span class="p">(</span>
          <span class="n">prot_ring_center</span><span class="p">,</span>
          <span class="n">prot_ring_normal</span><span class="p">,</span>
          <span class="n">lig_ring_center</span><span class="p">,</span>
          <span class="n">lig_ring_normal</span><span class="p">,</span>
          <span class="n">angle_cutoff</span><span class="o">=</span><span class="n">angle_cutoff</span><span class="p">,</span>
          <span class="n">dist_cutoff</span><span class="o">=</span><span class="n">dist_cutoff</span><span class="p">):</span>
        <span class="n">prot_to_update</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">lig_to_update</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">prot_atom_idx</span> <span class="ow">in</span> <span class="n">prot_ring</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">lig_atom_idx</span> <span class="ow">in</span> <span class="n">lig_ring</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">prot_atom_idx</span><span class="p">,</span> <span class="n">lig_atom_idx</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">counted_pairs_parallel</span><span class="p">:</span>
              <span class="c1"># if this pair is new, count atoms forming a contact</span>
              <span class="n">prot_to_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prot_atom_idx</span><span class="p">)</span>
              <span class="n">lig_to_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lig_atom_idx</span><span class="p">)</span>
              <span class="n">counted_pairs_parallel</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">prot_atom_idx</span><span class="p">,</span> <span class="n">lig_atom_idx</span><span class="p">))</span>

        <span class="n">protein_pi_parallel</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">prot_to_update</span><span class="p">)</span>
        <span class="n">ligand_pi_parallel</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lig_to_update</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">is_pi_t</span><span class="p">(</span>
          <span class="n">prot_ring_center</span><span class="p">,</span>
          <span class="n">prot_ring_normal</span><span class="p">,</span>
          <span class="n">lig_ring_center</span><span class="p">,</span>
          <span class="n">lig_ring_normal</span><span class="p">,</span>
          <span class="n">angle_cutoff</span><span class="o">=</span><span class="n">angle_cutoff</span><span class="p">,</span>
          <span class="n">dist_cutoff</span><span class="o">=</span><span class="n">dist_cutoff</span><span class="p">):</span>
        <span class="n">prot_to_update</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">lig_to_update</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">prot_atom_idx</span> <span class="ow">in</span> <span class="n">prot_ring</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">lig_atom_idx</span> <span class="ow">in</span> <span class="n">lig_ring</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">prot_atom_idx</span><span class="p">,</span> <span class="n">lig_atom_idx</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">counted_pairs_t</span><span class="p">:</span>
              <span class="c1"># if this pair is new, count atoms forming a contact</span>
              <span class="n">prot_to_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prot_atom_idx</span><span class="p">)</span>
              <span class="n">lig_to_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lig_atom_idx</span><span class="p">)</span>
              <span class="n">counted_pairs_t</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">prot_atom_idx</span><span class="p">,</span> <span class="n">lig_atom_idx</span><span class="p">))</span>

        <span class="n">protein_pi_t</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">prot_to_update</span><span class="p">)</span>
        <span class="n">ligand_pi_t</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lig_to_update</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">protein_pi_t</span><span class="p">,</span> <span class="n">protein_pi_parallel</span><span class="p">,</span> <span class="n">ligand_pi_t</span><span class="p">,</span> <span class="n">ligand_pi_parallel</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_cation_pi"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.is_cation_pi">[docs]</a><span class="k">def</span> <span class="nf">is_cation_pi</span><span class="p">(</span><span class="n">cation_position</span><span class="p">,</span>
                 <span class="n">ring_center</span><span class="p">,</span>
                 <span class="n">ring_normal</span><span class="p">,</span>
                 <span class="n">dist_cutoff</span><span class="o">=</span><span class="mf">6.5</span><span class="p">,</span>
                 <span class="n">angle_cutoff</span><span class="o">=</span><span class="mf">30.0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Check if a cation and an aromatic ring form contact.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    ring_center: np.ndarray</span>
<span class="sd">      Positions of ring center. Can be computed with the compute_ring_center</span>
<span class="sd">      function.</span>
<span class="sd">    ring_normal: np.ndarray</span>
<span class="sd">      Normal of ring. Can be computed with the compute_ring_normal function.</span>
<span class="sd">    dist_cutoff: float</span>
<span class="sd">      Distance cutoff. Max allowed distance between ring center and cation</span>
<span class="sd">      (in Angstroms).</span>
<span class="sd">    angle_cutoff: float</span>
<span class="sd">      Angle cutoff. Max allowed deviation from the ideal (0deg) angle between</span>
<span class="sd">      ring normal and vector pointing from ring center to cation (in degrees).</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">cation_to_ring_vec</span> <span class="o">=</span> <span class="n">cation_position</span> <span class="o">-</span> <span class="n">ring_center</span>
  <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cation_to_ring_vec</span><span class="p">)</span>
  <span class="n">angle</span> <span class="o">=</span> <span class="n">angle_between</span><span class="p">(</span><span class="n">cation_to_ring_vec</span><span class="p">,</span> <span class="n">ring_normal</span><span class="p">)</span> <span class="o">*</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="n">angle_cutoff</span> <span class="ow">or</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mf">180.0</span> <span class="o">-</span> <span class="n">angle_cutoff</span><span class="p">)</span> <span class="ow">and</span>
      <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_cutoff</span><span class="p">)):</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">return</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="compute_cation_pi"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_cation_pi">[docs]</a><span class="k">def</span> <span class="nf">compute_cation_pi</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span> <span class="n">mol2</span><span class="p">,</span> <span class="n">charge_tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Finds aromatic rings in mo1 and cations in mol2 that interact with each</span>
<span class="sd">  other.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    mol1: rdkit.rdchem.Mol</span>
<span class="sd">      Molecule to look for interacting rings</span>
<span class="sd">    mol2: rdkit.rdchem.Mol</span>
<span class="sd">      Molecule to look for interacting cations</span>
<span class="sd">    charge_tolerance: float</span>
<span class="sd">      Atom is considered a cation if its formal charge is greater than</span>
<span class="sd">      1 - charge_tolerance</span>
<span class="sd">    **kwargs:</span>
<span class="sd">      Arguments that are passed to is_cation_pi function</span>

<span class="sd">  Returns:</span>
<span class="sd">  --------</span>
<span class="sd">    mol1_pi: dict</span>
<span class="sd">      Dictionary that maps atom indices (from mol1) to the number of cations</span>
<span class="sd">      (in mol2) they interact with</span>
<span class="sd">    mol2_cation: dict</span>
<span class="sd">      Dictionary that maps atom indices (from mol2) to the number of aromatic</span>
<span class="sd">      atoms (in mol1) they interact with</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">mol1_pi</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
  <span class="n">mol2_cation</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
  <span class="n">conformer</span> <span class="o">=</span> <span class="n">mol2</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>

  <span class="n">aromatic_atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol1</span><span class="o">.</span><span class="n">GetAromaticAtoms</span><span class="p">())</span>
  <span class="n">rings</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Chem</span><span class="o">.</span><span class="n">GetSymmSSSR</span><span class="p">(</span><span class="n">mol1</span><span class="p">)]</span>

  <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
    <span class="c1"># if ring from mol1 is aromatic</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">aromatic_atoms</span><span class="p">):</span>
      <span class="n">ring_center</span> <span class="o">=</span> <span class="n">compute_ring_center</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span> <span class="n">ring</span><span class="p">)</span>
      <span class="n">ring_normal</span> <span class="o">=</span> <span class="n">compute_ring_normal</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span> <span class="n">ring</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol2</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
        <span class="c1"># ...and atom from mol2 is a cation</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetFormalCharge</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">charge_tolerance</span><span class="p">:</span>
          <span class="n">cation_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conformer</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()))</span>
          <span class="c1"># if angle and distance are correct</span>
          <span class="k">if</span> <span class="n">is_cation_pi</span><span class="p">(</span><span class="n">cation_position</span><span class="p">,</span> <span class="n">ring_center</span><span class="p">,</span> <span class="n">ring_normal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># count atoms forming a contact</span>
            <span class="n">mol1_pi</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
            <span class="n">mol2_cation</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIndex</span><span class="p">()])</span>
  <span class="k">return</span> <span class="n">mol1_pi</span><span class="p">,</span> <span class="n">mol2_cation</span></div>


<div class="viewcode-block" id="compute_binding_pocket_cation_pi"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_binding_pocket_cation_pi">[docs]</a><span class="k">def</span> <span class="nf">compute_binding_pocket_cation_pi</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Finds cation-pi interactions between protein and ligand.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    protein, ligand: rdkit.rdchem.Mol</span>
<span class="sd">      Interacting molecules</span>
<span class="sd">    **kwargs:</span>
<span class="sd">      Arguments that are passed to compute_cation_pi function</span>

<span class="sd">  Returns:</span>
<span class="sd">  --------</span>
<span class="sd">    protein_cation_pi, ligand_cation_pi: dict</span>
<span class="sd">      Dictionaries that maps atom indices to the number of cations/aromatic</span>
<span class="sd">      atoms they interact with</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># find interacting rings from protein and cations from ligand</span>
  <span class="n">protein_pi</span><span class="p">,</span> <span class="n">ligand_cation</span> <span class="o">=</span> <span class="n">compute_cation_pi</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="c1"># find interacting cations from protein and rings from ligand</span>
  <span class="n">ligand_pi</span><span class="p">,</span> <span class="n">protein_cation</span> <span class="o">=</span> <span class="n">compute_cation_pi</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="c1"># merge counters</span>
  <span class="n">protein_cation_pi</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
  <span class="n">protein_cation_pi</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">protein_pi</span><span class="p">)</span>
  <span class="n">protein_cation_pi</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">protein_cation</span><span class="p">)</span>

  <span class="n">ligand_cation_pi</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
  <span class="n">ligand_cation_pi</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ligand_pi</span><span class="p">)</span>
  <span class="n">ligand_cation_pi</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ligand_cation</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">protein_cation_pi</span><span class="p">,</span> <span class="n">ligand_cation_pi</span></div>


<div class="viewcode-block" id="get_partial_charge"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.get_partial_charge">[docs]</a><span class="k">def</span> <span class="nf">get_partial_charge</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Get partial charge of a given atom (rdkit Atom object)&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;_GasteigerCharge&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;-nan&#39;</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="get_formal_charge"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.get_formal_charge">[docs]</a><span class="k">def</span> <span class="nf">get_formal_charge</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
  <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;get_formal_charge function is deprecated and will be removed&#39;</span>
       <span class="s1">&#39; in version 1.4, use get_partial_charge instead&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">get_partial_charge</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_salt_bridge"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.is_salt_bridge">[docs]</a><span class="k">def</span> <span class="nf">is_salt_bridge</span><span class="p">(</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">atom_j</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Check if two atoms have correct charges to form a salt bridge&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
      <span class="n">get_partial_charge</span><span class="p">(</span><span class="n">atom_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">get_partial_charge</span><span class="p">(</span><span class="n">atom_j</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">return</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="compute_salt_bridges"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_salt_bridges">[docs]</a><span class="k">def</span> <span class="nf">compute_salt_bridges</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span>
                         <span class="n">protein</span><span class="p">,</span>
                         <span class="n">ligand_xyz</span><span class="p">,</span>
                         <span class="n">ligand</span><span class="p">,</span>
                         <span class="n">pairwise_distances</span><span class="p">,</span>
                         <span class="n">cutoff</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Find salt bridge contacts between protein and lingand.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">  protein_xyz, ligand_xyz: np.ndarray</span>
<span class="sd">    Arrays with atomic coordinates</span>
<span class="sd">  protein, ligand: rdkit.rdchem.Mol</span>
<span class="sd">    Interacting molecules</span>
<span class="sd">  pairwise_distances: np.ndarray</span>
<span class="sd">    Array of pairwise protein-ligand distances (Angstroms)</span>
<span class="sd">  cutoff: float</span>
<span class="sd">    Cutoff distance for contact consideration</span>

<span class="sd">  Returns:</span>
<span class="sd">  --------</span>
<span class="sd">    salt_bridge_contacts: list of tuples</span>
<span class="sd">      List of contacts. Tuple (i, j) indicates that atom i from protein</span>
<span class="sd">      interacts with atom j from ligand.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">salt_bridge_contacts</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">contacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">pairwise_distances</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">)</span>
  <span class="n">contacts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contacts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">contacts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
    <span class="n">protein_atom</span> <span class="o">=</span> <span class="n">protein</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()[</span><span class="nb">int</span><span class="p">(</span><span class="n">contact</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">ligand_atom</span> <span class="o">=</span> <span class="n">ligand</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()[</span><span class="nb">int</span><span class="p">(</span><span class="n">contact</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">is_salt_bridge</span><span class="p">(</span><span class="n">protein_atom</span><span class="p">,</span> <span class="n">ligand_atom</span><span class="p">):</span>
      <span class="n">salt_bridge_contacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">salt_bridge_contacts</span></div>


<div class="viewcode-block" id="is_angle_within_cutoff"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.is_angle_within_cutoff">[docs]</a><span class="k">def</span> <span class="nf">is_angle_within_cutoff</span><span class="p">(</span><span class="n">vector_i</span><span class="p">,</span> <span class="n">vector_j</span><span class="p">,</span> <span class="n">hbond_angle_cutoff</span><span class="p">):</span>
  <span class="n">angle</span> <span class="o">=</span> <span class="n">angle_between</span><span class="p">(</span><span class="n">vector_i</span><span class="p">,</span> <span class="n">vector_j</span><span class="p">)</span> <span class="o">*</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="n">hbond_angle_cutoff</span><span class="p">)</span> <span class="ow">and</span>
          <span class="n">angle</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">180.</span> <span class="o">+</span> <span class="n">hbond_angle_cutoff</span><span class="p">))</span></div>


<div class="viewcode-block" id="is_hydrogen_bond"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.is_hydrogen_bond">[docs]</a><span class="k">def</span> <span class="nf">is_hydrogen_bond</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">contact</span><span class="p">,</span>
                     <span class="n">hbond_angle_cutoff</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Determine if a pair of atoms (contact = tuple of protein_atom_index, ligand_atom_index)</span>
<span class="sd">  between protein and ligand represents a hydrogen bond. Returns a boolean result.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># TODO(LESWING)</span>
  <span class="k">return</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="compute_hbonds_in_range"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_hbonds_in_range">[docs]</a><span class="k">def</span> <span class="nf">compute_hbonds_in_range</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">,</span>
                            <span class="n">pairwise_distances</span><span class="p">,</span> <span class="n">hbond_dist_bin</span><span class="p">,</span>
                            <span class="n">hbond_angle_cutoff</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Find all pairs of (protein_index_i, ligand_index_j) that hydrogen bond given</span>
<span class="sd">  a distance bin and an angle cutoff.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">contacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">pairwise_distances</span> <span class="o">&gt;</span> <span class="n">hbond_dist_bin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">pairwise_distances</span> <span class="o">&lt;</span> <span class="n">hbond_dist_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
  <span class="n">contacts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contacts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">contacts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="n">hydrogen_bond_contacts</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_hydrogen_bond</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">contact</span><span class="p">,</span>
                        <span class="n">hbond_angle_cutoff</span><span class="p">):</span>
      <span class="n">hydrogen_bond_contacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">hydrogen_bond_contacts</span></div>


<div class="viewcode-block" id="compute_hydrogen_bonds"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_hydrogen_bonds">[docs]</a><span class="k">def</span> <span class="nf">compute_hydrogen_bonds</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span>
                           <span class="n">pairwise_distances</span><span class="p">,</span> <span class="n">hbond_dist_bins</span><span class="p">,</span>
                           <span class="n">hbond_angle_cutoffs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes hydrogen bonds between proteins and ligands.</span>

<span class="sd">  Returns a list of sublists. Each sublist is a series of tuples of</span>
<span class="sd">  (protein_index_i, ligand_index_j) that represent a hydrogen bond. Each sublist</span>
<span class="sd">  represents a different type of hydrogen bond.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">hbond_contacts</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hbond_dist_bin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hbond_dist_bins</span><span class="p">):</span>
    <span class="n">hbond_angle_cutoff</span> <span class="o">=</span> <span class="n">hbond_angle_cutoffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">hbond_contacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">compute_hbonds_in_range</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">,</span>
                                <span class="n">pairwise_distances</span><span class="p">,</span> <span class="n">hbond_dist_bin</span><span class="p">,</span>
                                <span class="n">hbond_angle_cutoff</span><span class="p">))</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">hbond_contacts</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_atom_to_voxel"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.convert_atom_to_voxel">[docs]</a><span class="k">def</span> <span class="nf">convert_atom_to_voxel</span><span class="p">(</span><span class="n">molecule_xyz</span><span class="p">,</span>
                          <span class="n">atom_index</span><span class="p">,</span>
                          <span class="n">box_width</span><span class="p">,</span>
                          <span class="n">voxel_width</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Converts atom coordinates to an i,j,k grid index.</span>

<span class="sd">  Parameters:</span>
<span class="sd">  -----------</span>
<span class="sd">    molecule_xyz: np.ndarray</span>
<span class="sd">      Array with coordinates of all atoms in the molecule, shape (N, 3)</span>
<span class="sd">    atom_index: int</span>
<span class="sd">      Index of an atom</span>
<span class="sd">    box_width: float</span>
<span class="sd">      Size of a box</span>
<span class="sd">    voxel_width: float</span>
<span class="sd">      Size of a voxel</span>
<span class="sd">    verbose: bool</span>
<span class="sd">      Print warnings when atom is outside of a box</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
      <span class="p">(</span><span class="n">molecule_xyz</span><span class="p">[</span><span class="n">atom_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">voxel_width</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">indices</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">indices</span> <span class="o">&gt;=</span> <span class="n">box_width</span> <span class="o">/</span> <span class="n">voxel_width</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Coordinates are outside of the box (atom id = </span><span class="si">%s</span><span class="s1">,&#39;</span>
           <span class="s1">&#39; coords xyz = </span><span class="si">%s</span><span class="s1">, coords in box = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
           <span class="p">(</span><span class="n">atom_index</span><span class="p">,</span> <span class="n">molecule_xyz</span><span class="p">[</span><span class="n">atom_index</span><span class="p">],</span> <span class="n">indices</span><span class="p">))</span>

  <span class="k">return</span> <span class="p">([</span><span class="n">indices</span><span class="p">])</span></div>


<div class="viewcode-block" id="convert_atom_pair_to_voxel"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.convert_atom_pair_to_voxel">[docs]</a><span class="k">def</span> <span class="nf">convert_atom_pair_to_voxel</span><span class="p">(</span><span class="n">molecule_xyz_tuple</span><span class="p">,</span> <span class="n">atom_index_pair</span><span class="p">,</span> <span class="n">box_width</span><span class="p">,</span>
                               <span class="n">voxel_width</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Converts a pair of atoms to a list of i,j,k tuples.&quot;&quot;&quot;</span>

  <span class="n">indices_list</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">indices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
      <span class="n">convert_atom_to_voxel</span><span class="p">(</span><span class="n">molecule_xyz_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_index_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">box_width</span><span class="p">,</span> <span class="n">voxel_width</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">indices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
      <span class="n">convert_atom_to_voxel</span><span class="p">(</span><span class="n">molecule_xyz_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">atom_index_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">box_width</span><span class="p">,</span> <span class="n">voxel_width</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">indices_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_charge_dictionary"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.compute_charge_dictionary">[docs]</a><span class="k">def</span> <span class="nf">compute_charge_dictionary</span><span class="p">(</span><span class="n">molecule</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create a dictionary with partial charges for each atom in the molecule.</span>

<span class="sd">  This function assumes that the charges for the molecule are already</span>
<span class="sd">  computed (it can be done with rdkit_util.compute_charges(molecule))</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">charge_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()):</span>
    <span class="n">charge_dictionary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_partial_charge</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">charge_dictionary</span></div>


<div class="viewcode-block" id="subtract_centroid"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.subtract_centroid">[docs]</a><span class="k">def</span> <span class="nf">subtract_centroid</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">centroid</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Subtracts centroid from each coordinate.</span>

<span class="sd">  Subtracts the centroid, a numpy array of dim 3, from all coordinates of all</span>
<span class="sd">  atoms in the molecule</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">xyz</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">centroid</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">xyz</span><span class="p">)</span></div>


<div class="viewcode-block" id="RdkitGridFeaturizer"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.RdkitGridFeaturizer">[docs]</a><span class="k">class</span> <span class="nc">RdkitGridFeaturizer</span><span class="p">(</span><span class="n">ComplexFeaturizer</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Featurizes protein-ligand complex using flat features or a 3D grid (in which</span>
<span class="sd">  each voxel is described with a vector of features).</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">nb_rotations</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
               <span class="n">feature_types</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">ecfp_degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
               <span class="n">ecfp_power</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
               <span class="n">splif_power</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
               <span class="n">box_width</span><span class="o">=</span><span class="mf">16.0</span><span class="p">,</span>
               <span class="n">voxel_width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
               <span class="n">flatten</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
               <span class="n">sanitize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    nb_rotations: int, optional (default 0)</span>
<span class="sd">      Number of additional random rotations of a complex to generate.</span>
<span class="sd">    feature_types: list, optional (default [&#39;ecfp&#39;])</span>
<span class="sd">      Types of features to calculate. Available types are:</span>
<span class="sd">        flat features: &#39;ecfp_ligand&#39;, &#39;ecfp_hashed&#39;, &#39;splif_hashed&#39;, &#39;hbond_count&#39;</span>
<span class="sd">        voxel features: &#39;ecfp&#39;, &#39;splif&#39;, &#39;sybyl&#39;, &#39;salt_bridge&#39;, &#39;charge&#39;, &#39;hbond&#39;,</span>
<span class="sd">        &#39;pi_stack, &#39;cation_pi&#39;</span>
<span class="sd">      There are also 3 predefined sets of features: &#39;flat_combined&#39;,</span>
<span class="sd">      &#39;voxel_combined&#39;, and &#39;all_combined&#39;. Calculated features are concatenated</span>
<span class="sd">      and their order is preserved (features in predefined sets are in</span>
<span class="sd">      alphabetical order).</span>
<span class="sd">    ecfp_degree: int, optional (default 2)</span>
<span class="sd">      ECFP radius.</span>
<span class="sd">    ecfp_power: int, optional (default 3)</span>
<span class="sd">      Number of bits to store ECFP features (resulting vector will be</span>
<span class="sd">      2^ecfp_power long)</span>
<span class="sd">    splif_power: int, optional (default 3)</span>
<span class="sd">      Number of bits to store SPLIF features (resulting vector will be</span>
<span class="sd">      2^splif_power long)</span>
<span class="sd">    box_width: float, optional (default 16.0)</span>
<span class="sd">      Size of a box in which voxel features are calculated. Box is centered on a</span>
<span class="sd">      ligand centroid.</span>
<span class="sd">    voxel_width: float, optional (default 1.0)</span>
<span class="sd">      Size of a 3D voxel in a grid.</span>
<span class="sd">    flatten: bool, optional (defaul False)</span>
<span class="sd">      Indicate whether calculated features should be flattened. Output is always</span>
<span class="sd">      flattened if flat features are specified in feature_types.</span>
<span class="sd">    verbose: bool, optional (defaul True)</span>
<span class="sd">      Verbolity for logging</span>
<span class="sd">    sanitize: bool, optional (defaul False)</span>
<span class="sd">      If set to True molecules will be sanitized. Note that calculating some</span>
<span class="sd">      features (e.g. aromatic interactions) require sanitized molecules.</span>
<span class="sd">    **kwargs: dict, optional</span>
<span class="sd">      Keyword arguments can be usaed to specify custom cutoffs and bins (see</span>
<span class="sd">      default values below).</span>

<span class="sd">    Default cutoffs and bins:</span>
<span class="sd">    -------------------------</span>
<span class="sd">      hbond_dist_bins: [(2.2, 2.5), (2.5, 3.2), (3.2, 4.0)]</span>
<span class="sd">      hbond_angle_cutoffs: [5, 50, 90]</span>
<span class="sd">      splif_contact_bins: [(0, 2.0), (2.0, 3.0), (3.0, 4.5)]</span>
<span class="sd">      ecfp_cutoff: 4.5</span>
<span class="sd">      sybyl_cutoff: 7.0</span>
<span class="sd">      salt_bridges_cutoff: 5.0</span>
<span class="sd">      pi_stack_dist_cutoff: 4.4</span>
<span class="sd">      pi_stack_angle_cutoff: 30.0</span>
<span class="sd">      cation_pi_dist_cutoff: 6.5</span>
<span class="sd">      cation_pi_angle_cutoff: 30.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check if user tries to set removed arguments</span>
    <span class="n">deprecated_args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;box_x&#39;</span><span class="p">,</span> <span class="s1">&#39;box_y&#39;</span><span class="p">,</span> <span class="s1">&#39;box_z&#39;</span><span class="p">,</span> <span class="s1">&#39;save_intermediates&#39;</span><span class="p">,</span> <span class="s1">&#39;voxelize_features&#39;</span><span class="p">,</span>
        <span class="s1">&#39;parallel&#39;</span><span class="p">,</span> <span class="s1">&#39;voxel_feature_types&#39;</span>
    <span class="p">]</span>

    <span class="c1"># list of features that require sanitized molecules</span>
    <span class="n">require_sanitized</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pi_stack&#39;</span><span class="p">,</span> <span class="s1">&#39;cation_pi&#39;</span><span class="p">,</span> <span class="s1">&#39;ecfp_ligand&#39;</span><span class="p">]</span>

    <span class="c1"># not implemented featurization types</span>
    <span class="n">not_implemented</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sybyl&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">deprecated_args</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> argument was removed and it is ignored,&#39;</span>
             <span class="s1">&#39; using it will result in error in version 1.4&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">,</span>
             <span class="ne">DeprecationWarning</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sanitize</span> <span class="o">=</span> <span class="n">sanitize</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">flatten</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ecfp_degree</span> <span class="o">=</span> <span class="n">ecfp_degree</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ecfp_power</span> <span class="o">=</span> <span class="n">ecfp_power</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">splif_power</span> <span class="o">=</span> <span class="n">splif_power</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nb_rotations</span> <span class="o">=</span> <span class="n">nb_rotations</span>

    <span class="c1"># default values</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;hbond_dist_bins&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mf">2.2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">),</span> <span class="p">(</span><span class="mf">3.2</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)],</span>
        <span class="s1">&#39;hbond_angle_cutoffs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span>
        <span class="s1">&#39;splif_contact_bins&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">)],</span>
        <span class="s1">&#39;ecfp_cutoff&#39;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
        <span class="s1">&#39;sybyl_cutoff&#39;</span><span class="p">:</span> <span class="mf">7.0</span><span class="p">,</span>
        <span class="s1">&#39;salt_bridges_cutoff&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="s1">&#39;pi_stack_dist_cutoff&#39;</span><span class="p">:</span> <span class="mf">4.4</span><span class="p">,</span>
        <span class="s1">&#39;pi_stack_angle_cutoff&#39;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="s1">&#39;cation_pi_dist_cutoff&#39;</span><span class="p">:</span> <span class="mf">6.5</span><span class="p">,</span>
        <span class="s1">&#39;cation_pi_angle_cutoff&#39;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># update with cutoffs specified by the user</span>
    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">box_width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">box_width</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">voxel_width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">voxel_width</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">voxels_per_edge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_width</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">sybyl_types</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;Cac&quot;</span><span class="p">,</span> <span class="s2">&quot;Car&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;N3+&quot;</span><span class="p">,</span> <span class="s2">&quot;Npl&quot;</span><span class="p">,</span> <span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;Ng+&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Nox&quot;</span><span class="p">,</span> <span class="s2">&quot;Nar&quot;</span><span class="p">,</span> <span class="s2">&quot;Ntr&quot;</span><span class="p">,</span> <span class="s2">&quot;Nam&quot;</span><span class="p">,</span> <span class="s2">&quot;Npl3&quot;</span><span class="p">,</span> <span class="s2">&quot;N4&quot;</span><span class="p">,</span> <span class="s2">&quot;O3&quot;</span><span class="p">,</span> <span class="s2">&quot;O-&quot;</span><span class="p">,</span> <span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="s2">&quot;O.co2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;O.spc&quot;</span><span class="p">,</span> <span class="s2">&quot;O.t3p&quot;</span><span class="p">,</span> <span class="s2">&quot;S3&quot;</span><span class="p">,</span> <span class="s2">&quot;S3+&quot;</span><span class="p">,</span> <span class="s2">&quot;S2&quot;</span><span class="p">,</span> <span class="s2">&quot;So2&quot;</span><span class="p">,</span> <span class="s2">&quot;Sox&quot;</span>
        <span class="s2">&quot;Sac&quot;</span>
        <span class="s2">&quot;SO&quot;</span><span class="p">,</span> <span class="s2">&quot;P3&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;P3+&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;Cl&quot;</span><span class="p">,</span> <span class="s2">&quot;Br&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span>
    <span class="p">]</span>

    <span class="c1"># define methods to calculate available flat features</span>
    <span class="c1"># all methods (flat and voxel) must have the same API:</span>
    <span class="c1"># f(prot_xyz, prot_rdk, lig_xyz, lig_rdk, distances) -&gt; list of np.ndarrays</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">FLAT_FEATURES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ecfp_ligand&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="n">compute_ecfp_features</span><span class="p">(</span>
                <span class="n">lig_rdk</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecfp_degree</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecfp_power</span><span class="p">)],</span>

        <span class="s1">&#39;ecfp_hashed&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_vectorize</span><span class="p">(</span>
                <span class="n">hash_ecfp</span><span class="p">,</span>
                <span class="n">feature_dict</span><span class="o">=</span><span class="n">ecfp_dict</span><span class="p">,</span>
                <span class="n">channel_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ecfp_power</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">ecfp_dict</span> <span class="ow">in</span> <span class="n">featurize_binding_pocket_ecfp</span><span class="p">(</span>
                <span class="n">prot_xyz</span><span class="p">,</span>
                <span class="n">prot_rdk</span><span class="p">,</span>
                <span class="n">lig_xyz</span><span class="p">,</span>
                <span class="n">lig_rdk</span><span class="p">,</span>
                <span class="n">distances</span><span class="p">,</span>
                <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;ecfp_cutoff&#39;</span><span class="p">],</span>
                <span class="n">ecfp_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ecfp_degree</span><span class="p">)],</span>

        <span class="s1">&#39;splif_hashed&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_vectorize</span><span class="p">(</span>
                <span class="n">hash_ecfp_pair</span><span class="p">,</span>
                <span class="n">feature_dict</span><span class="o">=</span><span class="n">splif_dict</span><span class="p">,</span>
                <span class="n">channel_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">splif_power</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">splif_dict</span> <span class="ow">in</span> <span class="n">featurize_splif</span><span class="p">(</span>
                <span class="n">prot_xyz</span><span class="p">,</span>
                <span class="n">prot_rdk</span><span class="p">,</span>
                <span class="n">lig_xyz</span><span class="p">,</span>
                <span class="n">lig_rdk</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;splif_contact_bins&#39;</span><span class="p">],</span>
                <span class="n">distances</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecfp_degree</span><span class="p">)],</span>

        <span class="s1">&#39;hbond_count&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_vectorize</span><span class="p">(</span>
                <span class="n">hash_ecfp_pair</span><span class="p">,</span>
                <span class="n">feature_list</span><span class="o">=</span><span class="n">hbond_list</span><span class="p">,</span>
                <span class="n">channel_power</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">hbond_list</span> <span class="ow">in</span> <span class="n">compute_hydrogen_bonds</span><span class="p">(</span>
                <span class="n">prot_xyz</span><span class="p">,</span>
                <span class="n">prot_rdk</span><span class="p">,</span>
                <span class="n">lig_xyz</span><span class="p">,</span>
                <span class="n">lig_rdk</span><span class="p">,</span>
                <span class="n">distances</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;hbond_dist_bins&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;hbond_angle_cutoffs&#39;</span><span class="p">])]</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">voxelize_pi_stack</span><span class="p">(</span><span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
      <span class="n">protein_pi_t</span><span class="p">,</span> <span class="n">protein_pi_parallel</span><span class="p">,</span> <span class="n">ligand_pi_t</span><span class="p">,</span> <span class="n">ligand_pi_parallel</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">compute_pi_stack</span><span class="p">(</span>
              <span class="n">prot_rdk</span><span class="p">,</span>
              <span class="n">lig_rdk</span><span class="p">,</span>
              <span class="n">distances</span><span class="p">,</span>
              <span class="n">dist_cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;pi_stack_dist_cutoff&#39;</span><span class="p">],</span>
              <span class="n">angle_cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;pi_stack_angle_cutoff&#39;</span><span class="p">]))</span>
      <span class="n">pi_parallel_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
          <span class="n">convert_atom_to_voxel</span><span class="p">,</span>
          <span class="bp">None</span><span class="p">,</span>
          <span class="n">prot_xyz</span><span class="p">,</span>
          <span class="n">feature_dict</span><span class="o">=</span><span class="n">protein_pi_parallel</span><span class="p">,</span>
          <span class="n">nb_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">pi_parallel_tensor</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
          <span class="n">convert_atom_to_voxel</span><span class="p">,</span>
          <span class="bp">None</span><span class="p">,</span>
          <span class="n">lig_xyz</span><span class="p">,</span>
          <span class="n">feature_dict</span><span class="o">=</span><span class="n">ligand_pi_parallel</span><span class="p">,</span>
          <span class="n">nb_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

      <span class="n">pi_t_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
          <span class="n">convert_atom_to_voxel</span><span class="p">,</span>
          <span class="bp">None</span><span class="p">,</span>
          <span class="n">prot_xyz</span><span class="p">,</span>
          <span class="n">feature_dict</span><span class="o">=</span><span class="n">protein_pi_t</span><span class="p">,</span>
          <span class="n">nb_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">pi_t_tensor</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
          <span class="n">convert_atom_to_voxel</span><span class="p">,</span>
          <span class="bp">None</span><span class="p">,</span>
          <span class="n">lig_xyz</span><span class="p">,</span>
          <span class="n">feature_dict</span><span class="o">=</span><span class="n">ligand_pi_t</span><span class="p">,</span>
          <span class="n">nb_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">pi_parallel_tensor</span><span class="p">,</span> <span class="n">pi_t_tensor</span><span class="p">]</span>

    <span class="c1"># define methods to calculate available voxel features</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">VOXEL_FEATURES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ecfp&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
                <span class="n">convert_atom_to_voxel</span><span class="p">,</span>
                <span class="n">hash_ecfp</span><span class="p">,</span>
                <span class="n">xyz</span><span class="p">,</span>
                <span class="n">feature_dict</span><span class="o">=</span><span class="n">ecfp_dict</span><span class="p">,</span>
                <span class="n">channel_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ecfp_power</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">ecfp_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">(</span><span class="n">prot_xyz</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">),</span> <span class="n">featurize_binding_pocket_ecfp</span><span class="p">(</span>
                    <span class="n">prot_xyz</span><span class="p">,</span>
                    <span class="n">prot_rdk</span><span class="p">,</span>
                    <span class="n">lig_xyz</span><span class="p">,</span>
                    <span class="n">lig_rdk</span><span class="p">,</span>
                    <span class="n">distances</span><span class="p">,</span>
                    <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;ecfp_cutoff&#39;</span><span class="p">],</span>
                    <span class="n">ecfp_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ecfp_degree</span>
                <span class="p">))])],</span>

        <span class="s1">&#39;splif&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
                <span class="n">convert_atom_pair_to_voxel</span><span class="p">,</span>
                <span class="n">hash_ecfp_pair</span><span class="p">,</span>
                <span class="p">(</span><span class="n">prot_xyz</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">),</span>
                <span class="n">feature_dict</span><span class="o">=</span><span class="n">splif_dict</span><span class="p">,</span>
                <span class="n">channel_power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">splif_power</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">splif_dict</span> <span class="ow">in</span> <span class="n">featurize_splif</span><span class="p">(</span>
                <span class="n">prot_xyz</span><span class="p">,</span>
                <span class="n">prot_rdk</span><span class="p">,</span>
                <span class="n">lig_xyz</span><span class="p">,</span>
                <span class="n">lig_rdk</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;splif_contact_bins&#39;</span><span class="p">],</span>
                <span class="n">distances</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecfp_degree</span><span class="p">)],</span>

        <span class="s1">&#39;sybyl&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
                <span class="n">convert_atom_to_voxel</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hash_sybyl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sybyl_types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sybyl_types</span><span class="p">),</span>
                <span class="n">xyz</span><span class="p">,</span>
                <span class="n">feature_dict</span><span class="o">=</span><span class="n">sybyl_dict</span><span class="p">,</span>
                <span class="n">nb_channel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sybyl_types</span><span class="p">)</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">sybyl_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">(</span><span class="n">prot_xyz</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">),</span> <span class="n">featurize_binding_pocket_sybyl</span><span class="p">(</span>
                    <span class="n">prot_xyz</span><span class="p">,</span>
                    <span class="n">prot_rdk</span><span class="p">,</span>
                    <span class="n">lig_xyz</span><span class="p">,</span>
                    <span class="n">lig_rdk</span><span class="p">,</span>
                    <span class="n">distances</span><span class="p">,</span>
                    <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;sybyl_cutoff&#39;</span><span class="p">]</span>
                <span class="p">))],</span>

        <span class="s1">&#39;salt_bridge&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
                <span class="n">convert_atom_pair_to_voxel</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">,</span>
                <span class="p">(</span><span class="n">prot_xyz</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">),</span>
                <span class="n">feature_list</span><span class="o">=</span><span class="n">compute_salt_bridges</span><span class="p">(</span>
                    <span class="n">prot_xyz</span><span class="p">,</span>
                    <span class="n">prot_rdk</span><span class="p">,</span>
                    <span class="n">lig_xyz</span><span class="p">,</span>
                    <span class="n">lig_rdk</span><span class="p">,</span>
                    <span class="n">distances</span><span class="p">,</span>
                    <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;salt_bridges_cutoff&#39;</span><span class="p">]),</span>
                <span class="n">nb_channel</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)],</span>

        <span class="s1">&#39;charge&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
                <span class="n">convert_atom_to_voxel</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">,</span>
                <span class="n">xyz</span><span class="p">,</span>
                <span class="n">feature_dict</span><span class="o">=</span><span class="n">compute_charge_dictionary</span><span class="p">(</span><span class="n">mol</span><span class="p">),</span>
                <span class="n">nb_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;np.float16&quot;</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="p">((</span><span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">),</span> <span class="p">(</span><span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">))])],</span>

        <span class="s1">&#39;hbond&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
                <span class="n">convert_atom_pair_to_voxel</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">,</span>
                <span class="p">(</span><span class="n">prot_xyz</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">),</span>
                <span class="n">feature_list</span><span class="o">=</span><span class="n">hbond_list</span><span class="p">,</span>
                <span class="n">channel_power</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">hbond_list</span> <span class="ow">in</span> <span class="n">compute_hydrogen_bonds</span><span class="p">(</span>
                <span class="n">prot_xyz</span><span class="p">,</span>
                <span class="n">prot_rdk</span><span class="p">,</span>
                <span class="n">lig_xyz</span><span class="p">,</span>
                <span class="n">lig_rdk</span><span class="p">,</span>
                <span class="n">distances</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;hbond_dist_bins&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;hbond_angle_cutoffs&#39;</span><span class="p">])</span>
            <span class="p">],</span>
        <span class="s1">&#39;pi_stack&#39;</span><span class="p">:</span> <span class="n">voxelize_pi_stack</span><span class="p">,</span>

        <span class="s1">&#39;cation_pi&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">prot_xyz</span><span class="p">,</span> <span class="n">prot_rdk</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">,</span> <span class="n">lig_rdk</span><span class="p">,</span> <span class="n">distances</span><span class="p">:</span>
            <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_voxelize</span><span class="p">(</span>
                <span class="n">convert_atom_to_voxel</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">,</span>
                <span class="n">xyz</span><span class="p">,</span>
                <span class="n">feature_dict</span><span class="o">=</span><span class="n">cation_pi_dict</span><span class="p">,</span>
                <span class="n">nb_channel</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">cation_pi_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">(</span><span class="n">prot_xyz</span><span class="p">,</span> <span class="n">lig_xyz</span><span class="p">),</span> <span class="n">compute_binding_pocket_cation_pi</span><span class="p">(</span>
                    <span class="n">prot_rdk</span><span class="p">,</span>
                    <span class="n">lig_rdk</span><span class="p">,</span>
                    <span class="n">dist_cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;cation_pi_dist_cutoff&#39;</span><span class="p">],</span>
                    <span class="n">angle_cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoffs</span><span class="p">[</span><span class="s1">&#39;cation_pi_angle_cutoff&#39;</span><span class="p">],</span>
                <span class="p">))])],</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">feature_types</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">feature_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ecfp&#39;</span><span class="p">]</span>

    <span class="c1"># each entry is a tuple (is_flat, feature_name)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># list of features that cannot be calculated with specified parameters</span>
    <span class="c1"># this list is used to define &lt;flat/voxel/all&gt;_combined subset</span>
    <span class="n">ignored_features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
      <span class="n">ignored_features</span> <span class="o">+=</span> <span class="n">require_sanitized</span>
    <span class="n">ignored_features</span> <span class="o">+=</span> <span class="n">not_implemented</span>

    <span class="c1"># parse provided feature types</span>
    <span class="k">for</span> <span class="n">feature_type</span> <span class="ow">in</span> <span class="n">feature_types</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">feature_type</span> <span class="ow">in</span> <span class="n">require_sanitized</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
          <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;sanitize is set to False, </span><span class="si">%s</span><span class="s1"> feature will be ignored&#39;</span> <span class="o">%</span>
               <span class="n">feature_type</span><span class="p">)</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="n">feature_type</span> <span class="ow">in</span> <span class="n">not_implemented</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
          <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> feature is not implemented yet and will be ignored&#39;</span> <span class="o">%</span>
               <span class="n">feature_type</span><span class="p">)</span>
        <span class="k">continue</span>

      <span class="k">if</span> <span class="n">feature_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAT_FEATURES</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="n">feature_type</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> feature is used, output will be flattened&#39;</span> <span class="o">%</span> <span class="n">feature_type</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="k">elif</span> <span class="n">feature_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOXEL_FEATURES</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">False</span><span class="p">,</span> <span class="n">feature_type</span><span class="p">))</span>

      <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;flat_combined&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span> <span class="o">+=</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAT_FEATURES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                               <span class="k">if</span> <span class="n">ftype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignored_features</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Flat features are used, output will be flattened&#39;</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;voxel_combined&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span> <span class="o">+=</span> <span class="p">[(</span><span class="bp">False</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VOXEL_FEATURES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                               <span class="k">if</span> <span class="n">ftype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignored_features</span><span class="p">]</span>
      <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;all_combined&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span> <span class="o">+=</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAT_FEATURES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                               <span class="k">if</span> <span class="n">ftype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignored_features</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span> <span class="o">+=</span> <span class="p">[(</span><span class="bp">False</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VOXEL_FEATURES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                               <span class="k">if</span> <span class="n">ftype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignored_features</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Flat feature are used, output will be flattened&#39;</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Ignoring unknown feature </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">feature_type</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_featurize_complex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ligand_ext</span><span class="p">,</span> <span class="n">ligand_lines</span><span class="p">,</span> <span class="n">protein_pdb_lines</span><span class="p">):</span>
    <span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

    <span class="c1">############################################################## TIMING</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">ligand_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="s2">&quot;ligand.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ligand_ext</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ligand_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mol_f</span><span class="p">:</span>
      <span class="n">mol_f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">ligand_lines</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;TIMING: Writing ligand took </span><span class="si">%0.3f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>

    <span class="c1">############################################################## TIMING</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">protein_pdb_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="s2">&quot;protein.pdb&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">protein_pdb_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">protein_f</span><span class="p">:</span>
      <span class="n">protein_f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">protein_pdb_lines</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;TIMING: Writing protein took </span><span class="si">%0.3f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>

    <span class="n">features_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">(</span><span class="n">protein_pdb_file</span><span class="p">,</span> <span class="n">ligand_file</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<div class="viewcode-block" id="RdkitGridFeaturizer.featurize_complexes"><a class="viewcode-back" href="../../../deepchem.feat.html#deepchem.feat.rdkit_grid_featurizer.RdkitGridFeaturizer.featurize_complexes">[docs]</a>  <span class="k">def</span> <span class="nf">featurize_complexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_files</span><span class="p">,</span> <span class="n">protein_pdbs</span><span class="p">,</span> <span class="n">log_every_n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate features for mol/protein complexes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mols: list</span>
<span class="sd">      List of PDB filenames for molecules.</span>
<span class="sd">    protein_pdbs: list</span>
<span class="sd">      List of PDB filenames for proteins.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mol_file</span><span class="p">,</span> <span class="n">protein_pdb</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mol_files</span><span class="p">,</span> <span class="n">protein_pdbs</span><span class="p">)):</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">log_every_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Featurizing </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol_files</span><span class="p">)))</span>
      <span class="n">ligand_ext</span> <span class="o">=</span> <span class="n">get_ligand_filetype</span><span class="p">(</span><span class="n">mol_file</span><span class="p">)</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mol_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">mol_f</span><span class="p">:</span>
        <span class="n">mol_lines</span> <span class="o">=</span> <span class="n">mol_f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">protein_pdb</span><span class="p">)</span> <span class="k">as</span> <span class="n">protein_file</span><span class="p">:</span>
        <span class="n">protein_pdb_lines</span> <span class="o">=</span> <span class="n">protein_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
      <span class="n">features</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_featurize_complex</span><span class="p">(</span><span class="n">ligand_ext</span><span class="p">,</span> <span class="n">mol_lines</span><span class="p">,</span>
                                          <span class="n">protein_pdb_lines</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

  <span class="k">def</span> <span class="nf">_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein_pdb</span><span class="p">,</span> <span class="n">ligand_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes featurization of protein/ligand complex.</span>

<span class="sd">    Takes as input files (strings) for pdb of the protein, pdb of the ligand,</span>
<span class="sd">    and a directory to save intermediate files.</span>

<span class="sd">    This function then computes the centroid of the ligand; decrements this</span>
<span class="sd">    centroid from the atomic coordinates of protein and ligand atoms, and then</span>
<span class="sd">    merges the translated protein and ligand. This combined system/complex is then</span>
<span class="sd">    saved.</span>

<span class="sd">    This function then computes a featurization with scheme specified by the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">############################################################## TIMING</span>

    <span class="n">protein_xyz</span><span class="p">,</span> <span class="n">protein_rdk</span> <span class="o">=</span> <span class="n">load_molecule</span><span class="p">(</span>
        <span class="n">protein_pdb</span><span class="p">,</span> <span class="n">calc_charges</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sanitize</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;TIMING: Loading protein coordinates took </span><span class="si">%0.3f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">ligand_xyz</span><span class="p">,</span> <span class="n">ligand_rdk</span> <span class="o">=</span> <span class="n">load_molecule</span><span class="p">(</span>
        <span class="n">ligand_file</span><span class="p">,</span> <span class="n">calc_charges</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sanitize</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;TIMING: Loading ligand coordinates took </span><span class="si">%0.3f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>

    <span class="c1">############################################################## TIMING</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">(</span><span class="n">ligand_xyz</span><span class="p">)</span>
    <span class="n">ligand_xyz</span> <span class="o">=</span> <span class="n">subtract_centroid</span><span class="p">(</span><span class="n">ligand_xyz</span><span class="p">,</span> <span class="n">centroid</span><span class="p">)</span>
    <span class="n">protein_xyz</span> <span class="o">=</span> <span class="n">subtract_centroid</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">centroid</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;TIMING: Centroid processing took </span><span class="si">%0.3f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="c1">############################################################## TIMING</span>

    <span class="n">pairwise_distances</span> <span class="o">=</span> <span class="n">compute_pairwise_distances</span><span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">)</span>

    <span class="n">transformed_systems</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">transformed_systems</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_rotations</span><span class="p">):</span>
      <span class="n">rotated_system</span> <span class="o">=</span> <span class="n">rotate_molecules</span><span class="p">([</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">])</span>
      <span class="n">transformed_systems</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rotated_system</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">system_id</span><span class="p">,</span> <span class="p">(</span><span class="n">protein_xyz</span><span class="p">,</span> <span class="n">ligand_xyz</span><span class="p">)</span> <span class="ow">in</span> <span class="n">transformed_systems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">feature_arrays</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">is_flat</span><span class="p">,</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_flat</span><span class="p">:</span>
          <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAT_FEATURES</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOXEL_FEATURES</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>

        <span class="n">feature_arrays</span> <span class="o">+=</span> <span class="n">function</span><span class="p">(</span>
            <span class="n">protein_xyz</span><span class="p">,</span>
            <span class="n">protein_rdk</span><span class="p">,</span>
            <span class="n">ligand_xyz</span><span class="p">,</span>
            <span class="n">ligand_rdk</span><span class="p">,</span>
            <span class="n">pairwise_distances</span><span class="p">,)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">:</span>
          <span class="n">features</span><span class="p">[</span><span class="n">system_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
              <span class="p">[</span><span class="n">feature_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature_array</span> <span class="ow">in</span> <span class="n">feature_arrays</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">features</span><span class="p">[</span><span class="n">system_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">feature_arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span>

  <span class="k">def</span> <span class="nf">_voxelize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">get_voxels</span><span class="p">,</span>
                <span class="n">hash_function</span><span class="p">,</span>
                <span class="n">coordinates</span><span class="p">,</span>
                <span class="n">feature_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">feature_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">channel_power</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">nb_channel</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;np.int8&quot;</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">channel_power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">channel_power</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nb_channel</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">nb_channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">channel_power</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;np.int8&quot;</span><span class="p">:</span>
      <span class="n">feature_tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voxels_per_edge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxels_per_edge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxels_per_edge</span><span class="p">,</span>
           <span class="n">nb_channel</span><span class="p">),</span>
          <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">feature_tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voxels_per_edge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxels_per_edge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxels_per_edge</span><span class="p">,</span>
           <span class="n">nb_channel</span><span class="p">),</span>
          <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feature_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">feature_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">voxels</span> <span class="o">=</span> <span class="n">get_voxels</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_width</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="n">voxels</span><span class="p">:</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">voxel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">voxel</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxels_per_edge</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">hash_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
              <span class="n">feature_tensor</span><span class="p">[</span><span class="n">voxel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">voxel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">voxel</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                             <span class="n">hash_function</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">channel_power</span><span class="p">)]</span> <span class="o">+=</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">feature_tensor</span><span class="p">[</span><span class="n">voxel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">voxel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">voxel</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">features</span>
    <span class="k">elif</span> <span class="n">feature_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">:</span>
        <span class="n">voxels</span> <span class="o">=</span> <span class="n">get_voxels</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_width</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="n">voxels</span><span class="p">:</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">voxel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">voxel</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxels_per_edge</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">feature_tensor</span><span class="p">[</span><span class="n">voxel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">voxel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">voxel</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span>

    <span class="k">return</span> <span class="n">feature_tensor</span>

  <span class="k">def</span> <span class="nf">_vectorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">hash_function</span><span class="p">,</span>
                 <span class="n">feature_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">feature_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">channel_power</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">feature_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">channel_power</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feature_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">on_channels</span> <span class="o">=</span> <span class="p">[</span>
          <span class="n">hash_function</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">channel_power</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
      <span class="p">]</span>
      <span class="n">feature_vector</span><span class="p">[</span><span class="n">on_channels</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">feature_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">feature_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">feature_vector</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016, Stanford University and the Authors.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>